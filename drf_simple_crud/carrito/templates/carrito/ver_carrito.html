{% extends 'base.html' %}
{% load static %}

{% block title %}Mi Carrito{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4">Mi Carrito</h1>

  {% if items %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Producto</th>
            <th class="text-center">Cantidad</th>
            <th class="text-end">Precio unitario</th>
            <th class="text-end">Total</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td>
              {% if item.producto and item.producto.imagen %}
                <img src="{{ item.producto.imagen }}" alt="{{ item.nombre }}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;" class="me-2">
              {% endif %}
              {{ item.nombre }}
            </td>
            <td class="text-center">
              <div class="d-inline-flex align-items-center gap-2">
                <form method="post" action="{% url 'carrito:decrementar_cantidad' %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="detalle_id" value="{{ item.idcarritodetalle }}">
                  <button type="submit" class="btn btn-sm btn-outline-secondary" title="Restar uno">-</button>
                </form>
                <span class="mx-2">{{ item.cantidad }}</span>
                <form method="post" action="{% url 'carrito:incrementar_cantidad' %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="detalle_id" value="{{ item.idcarritodetalle }}">
                  <button type="submit" class="btn btn-sm btn-outline-secondary" title="Sumar uno">+</button>
                </form>
              </div>
            </td>
            <td class="text-end">$ {{ item.precio_unit_str }}</td>
            <td class="text-end fw-semibold">$ {{ item.total_linea_str }}</td>
            <td class="text-end">
              <form method="post" action="{% url 'carrito:eliminar_del_carrito' %}" onsubmit="return confirm('¿Eliminar este producto del carrito?');">
                {% csrf_token %}
                <input type="hidden" name="detalle_id" value="{{ item.idcarritodetalle }}">
                <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-end">Subtotal</th>
            <th class="text-end">$ {{ subtotal_str }}</th>
          </tr>
          <tr>
            <th colspan="3" class="text-end">Total</th>
            <th class="text-end">$ {{ subtotal_str }}</th>
          </tr>
        </tfoot>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info" role="alert">
      Tu carrito está vacío. Visita la <a href="{% url 'tienda:lista_productos' %}">tienda</a> para agregar productos.
    </div>
  {% endif %}

  {% if items and tiene_perfil %}
  <div class="mt-3 d-flex justify-content-end">
    <div class="text-end">
      <!-- Botón de pago con Mercado Pago -->
      <div id="mp-checkout-container"></div>
      <button id="mp-pay-btn" class="btn btn-primary mt-2">
        Pagar $ {{ subtotal_str }} con Mercado Pago
      </button>
      <div class="form-text">Serás redirigido a Mercado Pago para completar el pago.</div>
    </div>
  </div>
  {% endif %}
</div>

{% if items and tiene_perfil %}
<!-- SDK de Mercado Pago -->
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
(function(){
  const payBtn = document.getElementById('mp-pay-btn');
  if(!payBtn) return;

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  async function createPreference(){
    const res = await fetch("{% url 'carrito:mp_create_preference' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({})
    });
    if(!res.ok) {
      const t = await res.text();
      throw new Error('No se pudo iniciar el pago: ' + t);
    }
    return res.json();
  }

  payBtn.addEventListener('click', async function(){
    payBtn.disabled = true;
    payBtn.textContent = 'Redirigiendo a Mercado Pago...';
    try {
      const data = await createPreference();
      const publicKey = data.public_key || "{{ mp_public_key }}";
      const mp = new MercadoPago(publicKey, { locale: 'es-CO' });
      mp.checkout({
        preference: { id: data.preference_id },
        render: {
          container: '#mp-checkout-container',
          label: 'Pagar con Mercado Pago'
        }
      });
    } catch (e) {
      alert(e.message || 'Error iniciando el pago');
      payBtn.disabled = false;
      payBtn.textContent = 'Pagar $ {{ subtotal_str }} con Mercado Pago';
    }
  });
})();
</script>
{% endif %}
{% endblock %}
