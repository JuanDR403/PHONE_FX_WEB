<!-- templates/inicio/home.html -->
{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-body">
                    <table class="table table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Correo</th>
                                <th>Fecha Cita</th>
                                <th>Estado</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in citas %}
                            <tr class="main-row">
                                <td>{{ c.idcita }}</td>
                                <td>{{ c.cliente.nombre }} {{ c.cliente.apellido }}</td>
                                <td>
                                    {% if c.cliente.correo %}
                                        {{ c.cliente.correo }}
                                    {% elif c.cliente.user %}
                                        {{ c.cliente.user.username }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td class="fecha-display">{{ c.fecha_cita }}</td>
                                <td class="estado-display">
                                    {% if c.estado == 'finalizado' %}
                                        <span class="badge bg-success">Finalizado</span>
                                    {% elif c.estado == 'en proceso' %}
                                        <span class="badge bg-info text-dark">En Proceso</span>
                                    {% elif c.estado == 'pendiente' %}
                                        <span class="badge bg-warning text-dark">Solicitud</span>
                                    {% elif c.estado == 'olvidado' %}
                                        <span class="badge bg-danger">Olvidado</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ c.estado }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary toggle-row">
                                        <i class="fas fa-chevron-down"></i> Expandir
                                    </button>
                                </td>
                            </tr>
                            <tr class="expandable-row" style="display: none;">
                                <td colspan="6">
                                    <div class="p-3">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <h5>Descripci√≥n de {{ c.cliente.nombre }} {{ c.cliente.apellido }}</h5>
                                                {% if rol == "Admin" or rol ==  "cliente" %}
                                                <textarea class="form-control descripcion-persona" rows="3">{{ c.observaciones }}</textarea>
                                                {% else %}
                                                <p class="form-control-plaintext">{{ c.observaciones }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Fecha de Cita:</label>
                                                    <input type="text" class="form-control" value="{{ c.fecha_cita }} {{ c.hora_cita }}" disabled>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Estado:</label>
                                                    {% if rol == "Admin" or rol == "asesor" %}
                                                    <div class="estado-container" data-current-estado="{{ c.estado }}">
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input estado-radio" type="radio" name="estado-{{ c.idcita }}" id="solicitud-{{ c.idcita }}" value="pendiente" data-cita-id="{{ c.idcita }}" data-color="warning" data-display="Solicitud" {% if c.estado == 'pendiente' %}checked{% endif %}>
                                                            <label class="form-check-label" for="solicitud-{{ c.idcita }}">Solicitud</label>
                                                        </div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input estado-radio" type="radio" name="estado-{{ c.idcita }}" id="proceso-{{ c.idcita }}" value="en proceso" data-cita-id="{{ c.idcita }}" data-color="info" data-display="En Proceso" {% if c.estado == 'en proceso' %}checked{% endif %}>
                                                            <label class="form-check-label" for="proceso-{{ c.idcita }}">En Proceso</label>
                                                        </div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input estado-radio" type="radio" name="estado-{{ c.idcita }}" id="finalizado-{{ c.idcita }}" value="finalizado" data-cita-id="{{ c.idcita }}" data-color="success" data-display="Finalizado" {% if c.estado == 'finalizado' %}checked{% endif %}>
                                                            <label class="form-check-label" for="finalizado-{{ c.idcita }}">Finalizado</label>
                                                        </div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input estado-radio" type="radio" name="estado-{{ c.idcita }}" id="olvidado-{{ c.idcita }}" value="olvidado" data-cita-id="{{ c.idcita }}" data-color="danger" data-display="Olvidado" {% if c.estado == 'olvidado' %}checked{% endif %}>
                                                            <label class="form-check-label" for="olvidado-{{ c.idcita }}">Olvidado</label>
                                                        </div>
                                                    </div>
                                                    {% else %}
                                                    <p class="form-control-plaintext">{{ c.estado }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="mb-2">
                                                    <h6 class="mb-2">Historial de cambios</h6>
                                                    <ul class="list-group small" id="historial-list-{{ c.idcita }}">
                                                        {% for h in c.historiales.all|dictsortreversed:'fecha_cambio' %}
                                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                                            <div class="ms-2 me-auto">
                                                                <div><strong>{{ h.estado_anterior }}</strong> ‚Üí <strong>{{ h.estado_nuevo }}</strong></div>
                                                                <div class="text-muted">
                                                                    {% if rol == "Admin" or rol == "asesor" %}
                                                                        <textarea class="form-control form-control-sm observacion-input"
                                                                                  data-id="{{ h.idhistorial }}"
                                                                                  data-original="{{ h.observaciones|default:'' }}"
                                                                                  rows="2">{{ h.observaciones }}</textarea>
                                                                        <button class="btn btn-sm btn-primary mt-1 guardar-observacion-btn" disabled>Guardar</button>
                                                                    {% else %}
                                                                        <p class="form-control-plaintext">{{ h.observaciones }}</p>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <span class="badge bg-light text-muted">{{ h.fecha_cambio|date:'Y-m-d H:i' }}</span>
                                                        </li>
                                                        {% empty %}
                                                        <li class="list-group-item text-muted">Sin registros.</li>
                                                        {% endfor %}
                                                    </ul>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center">No hay citas registradas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .estado-container {
        display: flex;
        flex-wrap: wrap;
    }

    .form-check-inline {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .expandable-row {
        background-color: #f8f9fa;
    }

    .toggle-row:focus {
        box-shadow: none;
    }

    .fecha-entrega {
        min-width: 150px;
    }
</style>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Manejar la expansi√≥n/contracci√≥n de filas
        $(document).on('click', '.toggle-row', function() {
            const $button = $(this);
            const $mainRow = $button.closest('tr');
            const $expandableRow = $mainRow.next('.expandable-row');

            $expandableRow.toggle();

            if ($expandableRow.is(':visible')) {
                $button.html('<i class="fas fa-chevron-up"></i> Contraer');
            } else {
                $button.html('<i class="fas fa-chevron-down"></i> Expandir');
            }
        });

        // Cambio de estado
        $(document).on('change', '.estado-radio', function() {
            const $radio = $(this);
            const groupName = $radio.attr('name');
            $(`input[name="${groupName}"]`).not(this).prop('checked', false);

            const citaId = $radio.data('cita-id');
            const nuevoEstado = $radio.val();

            // Actualiza UI de inmediato
            updateEstadoDisplay(this);

            // Enviar al backend
            $.ajax({
                url: "{% url 'inicio:actualizar_estado_cita' %}",
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                data: { cita_id: citaId, estado: nuevoEstado },
                success: function(resp) {
                    if (!resp.ok) {
                        alert(resp.error || 'No se pudo actualizar.');
                    } else if (resp.badge) {
                        const $mainRow = $radio.closest('.expandable-row').prev('.main-row');
                        const $estadoCell = $mainRow.find('.estado-display');
                        const cls = resp.badge.cls;
                        const label = resp.badge.label;
                        const extra = (cls.includes('warning') || cls.includes('info')) ? ' text-dark' : '';
                        $estadoCell.html(`<span class="badge bg-${cls}">${label}</span>`);
                    }
                },
                error: function(xhr) {
                    alert('Error del servidor: ' + (xhr.responseJSON?.error || xhr.statusText));
                }
            });
        });

        // Actualizar la fecha mostrada cuando cambia un input de fecha
        $(document).on('change', '.fecha-entrega', function() { updateFechaDisplay(this); });

        function updateEstadoDisplay(radioButton) {
            const $radio = $(radioButton);
            const color = $radio.data('color');
            const display = $radio.data('display');
            const $mainRow = $radio.closest('.expandable-row').prev('.main-row');
            const $estadoCell = $mainRow.find('.estado-display');
            const extra = (color === 'warning' || color === 'info') ? ' text-dark' : '';
            $estadoCell.html(`<span class="badge bg-${color}${extra}">${display}</span>`);
        }

        function updateFechaDisplay(input) {
            const $input = $(input);
            const dateValue = $input.val();
            if (!dateValue) return;
            const parts = dateValue.split('-');
            const formatted = `${parts[2]}/${parts[1]}/${parts[0]}`;
            const $mainRow = $input.closest('.expandable-row').prev('.main-row');
            $mainRow.find('.fecha-display').text(formatted);
        }

        // ================================
        // üîπ Observaciones editables
        // ================================
        // Habilitar bot√≥n solo si hay cambios en observaciones
        $(document).on('input', '.observacion-input', function() {
            const $textarea = $(this);
            const original = $textarea.data('original');   // valor inicial desde data-original
            const $button = $textarea.next('.guardar-observacion-btn');
            $button.prop('disabled', $textarea.val().trim() === (original || '').trim());
        });

        // Guardar observaci√≥n modificada
        $(document).on('click', '.guardar-observacion-btn', function() {
            const $button = $(this);
            const $textarea = $button.prev('.observacion-input');
            const idHistorial = $textarea.data('id');
            const nuevaObs = $textarea.val().trim();

            $.ajax({
                url: "{% url 'inicio:actualizar_observacion' 0 %}".replace("0", idHistorial),
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                contentType: 'application/json',
                data: JSON.stringify({ observaciones: nuevaObs }),
                success: function(resp) {
                    if (resp.success) {
                        $button.prop('disabled', true).text('‚úÖ Guardado');
                        // actualizar valor original para futuras comparaciones
                        $textarea.data('original', nuevaObs);
                        setTimeout(() => $button.text('Guardar'), 2000);
                    } else {
                        alert(resp.error || 'No se pudo guardar la observaci√≥n.');
                    }
                },
                error: function(xhr) {
                    alert('Error del servidor: ' + (xhr.responseJSON?.error || xhr.statusText));
                }
            });
        });

    });
</script>

{% endblock %}
