<!-- templates/inicio/home.html -->
{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-body">
                <div class="d-flex justify-content-end mb-3">
                    {% if rol == "admin" or rol == "cliente" %}
                            <div class="d-flex justify-content-end mb-3">
                                <a href="{% url 'citas:agendar_cita' %}" class="btn btn-success">
                                    + Nueva Cita
                                </a>
                            </div>

                    {% endif %}
                </div>
                    <table class="table table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Correo</th>
                                <th>Fecha Cita</th>
                                <th>Estado</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in citas %}
                            <tr class="main-row">
                                <td>{{ c.idcita }}</td>
                                <td>{{ c.cliente.nombre }} {{ c.cliente.apellido }}</td>
                                <td>
                                    {% if c.cliente.correo %}
                                        {{ c.cliente.correo }}
                                    {% elif c.cliente.user %}
                                        {{ c.cliente.user.username }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td class="fecha-display">{{ c.fecha_cita_str }} {{ c.hora_cita_str }}</td>

                                <td class="estado-display">
                                    {% if c.estado == 'finalizado' %}
                                        <span class="badge bg-success">Finalizado</span>
                                    {% elif c.estado == 'en proceso' %}
                                        <span class="badge bg-info text-dark">En Proceso</span>
                                    {% elif c.estado == 'pendiente' %}
                                        <span class="badge bg-warning text-dark">Solicitud</span>
                                    {% elif c.estado == 'olvidado' %}
                                        <span class="badge bg-danger">Olvidado</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ c.estado }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary toggle-row">
                                        <i class="fas fa-chevron-down"></i> Expandir
                                    </button>
                                </td>
                            </tr>
                            <tr class="expandable-row" style="display: none;">
                                <td colspan="6">
                                    <div class="p-3">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <h5>Descripci√≥n de {{ c.cliente.nombre }} {{ c.cliente.apellido }}</h5>
                                                {% if rol == "admin" or rol == "cliente" %}
                                                <textarea class="form-control descripcion-cliente"
                                                          rows="3"
                                                          data-cita-id="{{ c.idcita }}"
                                                          data-original="{{ c.observaciones|default:'' }}"
                                                          {% if rol == "cliente" and c.cliente.user != request.user %}disabled{% endif %}>
                                                    {{ c.observaciones }}
                                                </textarea>
                                                <div class="mt-2">
                                                    <button class="btn btn-sm btn-primary guardar-descripcion-btn"
                                                            disabled
                                                            data-cita-id="{{ c.idcita }}">
                                                        <i class="fas fa-save"></i> Guardar Descripci√≥n
                                                    </button>
                                                    <span class="text-muted small ms-2" id="contador-descripcion-{{ c.idcita }}"></span>
                                                </div>
                                                {% else %}
                                                <p class="form-control-plaintext">{{ c.observaciones }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Fecha de Cita:</label>
                                                    <input type="text" class="form-control" value="{{ c.fecha_cita_str }} {{ c.hora_cita_str }}" disabled>


                                                 </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Estado:</label>
                                                    {% if rol == "admin" or rol == "asesor" %}
                                                    <div class="estado-container" data-current-estado="{{ c.estado }}">
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input estado-radio" type="radio" name="estado-{{ c.idcita }}" id="solicitud-{{ c.idcita }}" value="pendiente" data-cita-id="{{ c.idcita }}" data-color="warning" data-display="Solicitud" {% if c.estado == 'pendiente' %}checked{% endif %}>
                                                            <label class="form-check-label" for="solicitud-{{ c.idcita }}">Solicitud</label>
                                                        </div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input estado-radio" type="radio" name="estado-{{ c.idcita }}" id="proceso-{{ c.idcita }}" value="en proceso" data-cita-id="{{ c.idcita }}" data-color="info" data-display="En Proceso" {% if c.estado == 'en proceso' %}checked{% endif %}>
                                                            <label class="form-check-label" for="proceso-{{ c.idcita }}">En Proceso</label>
                                                        </div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input estado-radio" type="radio" name="estado-{{ c.idcita }}" id="finalizado-{{ c.idcita }}" value="finalizado" data-cita-id="{{ c.idcita }}" data-color="success" data-display="Finalizado" {% if c.estado == 'finalizado' %}checked{% endif %}>
                                                            <label class="form-check-label" for="finalizado-{{ c.idcita }}">Finalizado</label>
                                                        </div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input estado-radio" type="radio" name="estado-{{ c.idcita }}" id="olvidado-{{ c.idcita }}" value="olvidado" data-cita-id="{{ c.idcita }}" data-color="danger" data-display="Olvidado" {% if c.estado == 'olvidado' %}checked{% endif %}>
                                                            <label class="form-check-label" for="olvidado-{{ c.idcita }}">Olvidado</label>
                                                        </div>
                                                    </div>
                                                    {% else %}
                                                    <p class="form-control-plaintext">{{ c.estado }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="mb-2">
                                                    <h6 class="mb-2">Historial de cambios</h6>
                                                    <ul class="list-group small" id="historial-list-{{ c.idcita }}">
                                                        {% for h in c.historiales.all|dictsortreversed:'fecha_cambio' %}
                                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                                            <div class="ms-2 me-auto">
                                                                <div><strong>{{ h.estado_anterior }}</strong> ‚Üí <strong>{{ h.estado_nuevo }}</strong></div>
                                                                <div class="text-muted">
                                                                    {% if rol == "admin" or rol == "asesor" %}
                                                                        <textarea class="form-control form-control-sm observacion-input"
                                                                                  data-id="{{ h.idhistorial }}"
                                                                                  data-original="{{ h.observaciones|default:'' }}"
                                                                                  rows="2">{{ h.observaciones }}</textarea>
                                                                        <button class="btn btn-sm btn-primary mt-1 guardar-observacion-btn" disabled>Guardar</button>
                                                                    {% else %}
                                                                        <p class="form-control-plaintext">{{ h.observaciones }}</p>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <span class="badge bg-light text-muted">{{ h.fecha_cambio|date:'Y-m-d H:i' }}</span>
                                                        </li>
                                                        {% empty %}
                                                        <li class="list-group-item text-muted">Sin registros.</li>
                                                        {% endfor %}
                                                    </ul>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center">No hay citas registradas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>




        </div>
    </div>
</div>

<style>
    .estado-container {
        display: flex;
        flex-wrap: wrap;
    }

    .form-check-inline {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .expandable-row {
        background-color: #f8f9fa;
    }

    .toggle-row:focus {
        box-shadow: none;
    }

    .fecha-entrega {
        min-width: 150px;
    }
</style>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!--
ESTILOS CSS PERSONALIZADOS
Funci√≥n: Estilos espec√≠ficos para la tabla expandible y controles de estado
Incluye:
- Dise√±o responsive para contenedores de estado
- Estilos para filas expandibles
- Ajustes visuales para badges y botones
-->
<style>
    .estado-container {
        display: flex;
        flex-wrap: wrap;
    }

    .form-check-inline {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .expandable-row {
        background-color: #f8f9fa;
    }

    .toggle-row:focus {
        box-shadow: none;
    }

    .fecha-entrega {
        min-width: 150px;
    }
</style>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!--
SCRIPT PRINCIPAL: GESTI√ìN DE TABLA DE CITAS
Funci√≥n: Maneja toda la interactividad de la tabla de citas
Incluye:
- Expansi√≥n/contracci√≥n de filas
- Actualizaci√≥n de estados via AJAX
- Edici√≥n de observaciones en historial
- Manejo de CSRF token para seguridad
-->
<script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // üîπ FUNCIONALIDAD: Expansi√≥n/contracci√≥n de filas de la tabla
        $(document).on('click', '.toggle-row', function() {
            const $button = $(this);
            const $mainRow = $button.closest('tr');
            const $expandableRow = $mainRow.next('.expandable-row');

            $expandableRow.toggle();

            if ($expandableRow.is(':visible')) {
                $button.html('<i class="fas fa-chevron-up"></i> Contraer');
            } else {
                $button.html('<i class="fas fa-chevron-down"></i> Expandir');
            }
        });

        // üîπ FUNCIONALIDAD: Cambio de estado de cita via AJAX con SweetAlert
        $(document).on('change', '.estado-radio', function() {
            const $radio = $(this);
            const citaId = $radio.data('cita-id');
            const nuevoEstado = $radio.val();
            const estadoDisplay = $radio.data('display');

            // Mostrar confirmaci√≥n con SweetAlert
            Swal.fire({
                title: '¬øCambiar estado de cita?',
                html: `
                    <div class="text-center">
                        <i class="fas fa-sync-alt text-warning mb-3" style="font-size: 3rem;"></i>
                        <p>¬øEst√°s seguro de que quieres cambiar el estado a <strong>${estadoDisplay}</strong>?</p>
                        <p class="text-muted small">Cita ID: ${citaId}</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, Cambiar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                backdrop: true,
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    // Proceder con el cambio
                    cambiarEstadoCita($radio, citaId, nuevoEstado, estadoDisplay);
                } else {
                    // Revertir el cambio en el radio button
                    const groupName = $radio.attr('name');
                    const $container = $radio.closest('.estado-container');
                    const currentEstado = $container.data('current-estado');

                    // Restaurar el radio button anterior
                    $(`input[name="${groupName}"][value="${currentEstado}"]`).prop('checked', true);
                }
            });
        });

        // üîπ FUNCI√ìN: Realizar el cambio de estado via AJAX
        function cambiarEstadoCita($radio, citaId, nuevoEstado, estadoDisplay) {
            // Mostrar loading
            Swal.fire({
                title: 'Actualizando estado...',
                text: 'Por favor espera un momento',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Actualiza UI de inmediato
            updateEstadoDisplay($radio[0]);

            // Enviar al backend
            $.ajax({
                url: "{% url 'inicio:actualizar_estado_cita' %}",
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                data: { cita_id: citaId, estado: nuevoEstado },
                success: function(resp) {
                    Swal.close();

                    if (!resp.ok) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: resp.error || 'No se pudo actualizar el estado.',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#d33'
                        });

                        // Revertir UI en caso de error
                        const groupName = $radio.attr('name');
                        const $container = $radio.closest('.estado-container');
                        const currentEstado = $container.data('current-estado');
                        $(`input[name="${groupName}"][value="${currentEstado}"]`).prop('checked', true);
                        updateEstadoDisplay($(`input[name="${groupName}"][value="${currentEstado}"]`)[0]);

                    } else if (resp.badge) {
                        // √âxito - mostrar confirmaci√≥n
                        Swal.fire({
                            icon: 'success',
                            title: '¬°Estado Actualizado!',
                            html: `
                                <div class="text-center">
                                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                                    <p>El estado de la cita se cambi√≥ exitosamente a:</p>
                                    <span class="badge bg-${resp.badge.cls} fs-6">${resp.badge.label}</span>
                                </div>
                            `,
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            didClose: () => {
                        // Refrescar la p√°gina
                        location.reload();
                    }
                        });

                        // Actualizar tambi√©n en la fila principal
                        const $mainRow = $radio.closest('.expandable-row').prev('.main-row');
                        const $estadoCell = $mainRow.find('.estado-display');
                        const cls = resp.badge.cls;
                        const label = resp.badge.label;
                        const extra = (cls.includes('warning') || cls.includes('info')) ? ' text-dark' : '';
                        $estadoCell.html(`<span class="badge bg-${cls}${extra}">${label}</span>`);
                    }
                },
                error: function(xhr) {
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error del Servidor',
                        text: 'No se pudo conectar con el servidor. Intenta nuevamente.',
                        confirmButtonText: 'Reintentar',
                        confirmButtonColor: '#d33'
                    });

                    // Revertir UI en caso de error
                    const groupName = $radio.attr('name');
                    const $container = $radio.closest('.estado-container');
                    const currentEstado = $container.data('current-estado');
                    $(`input[name="${groupName}"][value="${currentEstado}"]`).prop('checked', true);
                    updateEstadoDisplay($(`input[name="${groupName}"][value="${currentEstado}"]`)[0]);
                }
            });
        }

        // üîπ FUNCI√ìN: Actualizar display del estado en la fila principal
        function updateEstadoDisplay(radioButton) {
            const $radio = $(radioButton);
            const color = $radio.data('color');
            const display = $radio.data('display');
            const $mainRow = $radio.closest('.expandable-row').prev('.main-row');
            const $estadoCell = $mainRow.find('.estado-display');
            const extra = (color === 'warning' || color === 'info') ? ' text-dark' : '';
            $estadoCell.html(`<span class="badge bg-${color}${extra}">${display}</span>`);
        }

        // üîπ FUNCIONALIDAD: Habilitar bot√≥n de guardar solo cuando hay cambios en observaciones
        $(document).on('input', '.observacion-input', function() {
            const $textarea = $(this);
            const original = $textarea.data('original');
            const $button = $textarea.next('.guardar-observacion-btn');
            $button.prop('disabled', $textarea.val().trim() === (original || '').trim());
        });

        // üîπ FUNCIONALIDAD: Guardar observaci√≥n modificada via AJAX con SweetAlert
        $(document).on('click', '.guardar-observacion-btn', function() {
            const $button = $(this);
            const $textarea = $button.prev('.observacion-input');
            const idHistorial = $textarea.data('id');
            const nuevaObs = $textarea.val().trim();
            const observacionOriginal = $textarea.data('original');

            // Validar que haya cambios
            if (nuevaObs === observacionOriginal) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sin Cambios',
                    text: 'No hay cambios para guardar.',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#ffc107',
                    timer: 1500
                });
                return;
            }

            // Mostrar confirmaci√≥n
            Swal.fire({
                title: '¬øGuardar observaci√≥n?',
                html: `
                    <div class="text-start">
                        <p><strong>Observaci√≥n anterior:</strong></p>
                        <p class="text-muted bg-light p-2 rounded">${observacionOriginal || '(Vac√≠o)'}</p>
                        <p><strong>Nueva observaci√≥n:</strong></p>
                        <p class="bg-light p-2 rounded">${nuevaObs || '(Vac√≠o)'}</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, Guardar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                backdrop: true
            }).then((result) => {
                if (result.isConfirmed) {
                    guardarObservacion($button, $textarea, idHistorial, nuevaObs);
                }
            });
        });

        // üîπ FUNCI√ìN: Realizar el guardado de observaci√≥n via AJAX
        function guardarObservacion($button, $textarea, idHistorial, nuevaObs) {
            // Mostrar loading
            Swal.fire({
                title: 'Guardando...',
                text: 'Actualizando observaci√≥n en el historial',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: "{% url 'inicio:actualizar_observacion' 0 %}".replace("0", idHistorial),
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                contentType: 'application/json',
                data: JSON.stringify({ observaciones: nuevaObs }),
                success: function(resp) {
                    Swal.close();

                    if (resp.success) {
                        // √âxito
                        $button.prop('disabled', true).text('‚úÖ Guardado');
                        $textarea.data('original', nuevaObs);

                        Swal.fire({
                            icon: 'success',
                            title: '¬°Observaci√≥n Guardada!',
                            text: 'La observaci√≥n se actualiz√≥ correctamente en el historial.',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true
                        });

                        setTimeout(() => {
                            $button.text('Guardar');
                        }, 2000);
                    } else {
                        // Error del servidor
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al Guardar',
                            text: resp.error || 'No se pudo guardar la observaci√≥n.',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#d33'
                        });

                        $button.prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Conexi√≥n',
                        text: 'No se pudo conectar con el servidor. Intenta nuevamente.',
                        confirmButtonText: 'Reintentar',
                        confirmButtonColor: '#d33'
                    });

                    $button.prop('disabled', false);
                }
            });
        }

        // üîπ INICIALIZAR: Contadores de caracteres para descripciones
    function inicializarContadoresDescripcion() {
        $('.descripcion-cliente').each(function() {
            const $textarea = $(this);
            const citaId = $textarea.data('cita-id');
            const maxCaracteres = 500;
            const caracteresActuales = $textarea.val().length;

            // Actualizar contador inicial
            $(`#contador-descripcion-${citaId}`).text(`${caracteresActuales}/${maxCaracteres} caracteres`);
        });
    }

    // üîπ FUNCIONALIDAD: Habilitar bot√≥n guardar cuando hay cambios en descripci√≥n
    $(document).on('input', '.descripcion-cliente', function() {
        const $textarea = $(this);
        const citaId = $textarea.data('cita-id');
        const original = $textarea.data('original');
        const $button = $(`.guardar-descripcion-btn[data-cita-id="${citaId}"]`);
        const maxCaracteres = 500;
        const caracteresActuales = $textarea.val().length;

        // Actualizar contador
        const $contador = $(`#contador-descripcion-${citaId}`);
        $contador.text(`${caracteresActuales}/${maxCaracteres} caracteres`);

        // Cambiar color del contador
        if (caracteresActuales > 450) {
            $contador.removeClass('text-muted text-warning').addClass('text-danger');
        } else if (caracteresActuales > 400) {
            $contador.removeClass('text-muted text-danger').addClass('text-warning');
        } else {
            $contador.removeClass('text-warning text-danger').addClass('text-muted');
        }

        // Habilitar/deshabilitar bot√≥n basado en cambios
        const hayCambios = $textarea.val().trim() !== (original || '').trim();
        $button.prop('disabled', !hayCambios);

        // Validar longitud m√°xima
        if (caracteresActuales > maxCaracteres) {
            $textarea.addClass('is-invalid');
            $button.prop('disabled', true);
        } else {
            $textarea.removeClass('is-invalid');
        }
    });

    // üîπ FUNCIONALIDAD: Guardar descripci√≥n del cliente via AJAX con SweetAlert
    $(document).on('click', '.guardar-descripcion-btn', function() {
        const $button = $(this);
        const citaId = $button.data('cita-id');
        const $textarea = $(`.descripcion-cliente[data-cita-id="${citaId}"]`);
        const nuevaDescripcion = $textarea.val().trim();
        const descripcionOriginal = $textarea.data('original');
        const maxCaracteres = 500;

        // Validar longitud
        if (nuevaDescripcion.length > maxCaracteres) {
            Swal.fire({
                icon: 'error',
                title: 'Texto demasiado largo',
                text: `La descripci√≥n no puede exceder ${maxCaracteres} caracteres.`,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#d33'
            });
            return;
        }

        // Validar que haya cambios
        if (nuevaDescripcion === descripcionOriginal) {
            Swal.fire({
                icon: 'warning',
                title: 'Sin Cambios',
                text: 'No hay cambios en la descripci√≥n para guardar.',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#ffc107',
                timer: 1500
            });
            return;
        }

        // Mostrar confirmaci√≥n con vista previa
        Swal.fire({
            title: '¬øGuardar descripci√≥n?',
            html: `
                <div class="text-start">
                    <p><strong>Descripci√≥n anterior:</strong></p>
                    <div class="bg-light p-2 rounded mb-3 small">
                        ${descripcionOriginal || '<span class="text-muted">(Vac√≠o)</span>'}
                    </div>
                    <p><strong>Nueva descripci√≥n:</strong></p>
                    <div class="bg-light p-2 rounded small">
                        ${nuevaDescripcion || '<span class="text-muted">(Vac√≠o)</span>'}
                    </div>
                    <p class="text-muted small mt-2">¬øConfirmas que quieres actualizar la descripci√≥n?</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'S√≠, Guardar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#d33',
            backdrop: true,
            width: '600px'
        }).then((result) => {
            if (result.isConfirmed) {
                guardarDescripcionCliente($button, $textarea, citaId, nuevaDescripcion);
            }
        });
    });

    // üîπ FUNCI√ìN: Realizar el guardado de descripci√≥n via AJAX
    function guardarDescripcionCliente($button, $textarea, citaId, nuevaDescripcion) {
        // Mostrar loading
        Swal.fire({
            title: 'Guardando descripci√≥n...',
            text: 'Actualizando observaciones de la cita',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        $.ajax({
            url: "{% url 'inicio:actualizar_descripcion_cita' %}", // Necesitar√°s crear esta URL
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                cita_id: citaId,
                descripcion: nuevaDescripcion
            },
            success: function(resp) {
                Swal.close();

                if (resp.success) {
                    // √âxito
                    $button.prop('disabled', true);
                    $button.html('<i class="fas fa-check"></i> Guardado');
                    $textarea.data('original', nuevaDescripcion);

                    Swal.fire({
                        icon: 'success',
                        title: '¬°Descripci√≥n Guardada!',
                        html: `
                            <div class="text-center">
                                <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                                <p>La descripci√≥n se actualiz√≥ correctamente.</p>
                            </div>
                        `,
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });

                    setTimeout(() => {
                        $button.html('<i class="fas fa-save"></i> Guardar Descripci√≥n');
                    }, 2000);

                } else {
                    // Error del servidor
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al Guardar',
                        text: resp.error || 'No se pudo guardar la descripci√≥n.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#d33'
                    });

                    $button.prop('disabled', false);
                }
            },
            error: function(xhr) {
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexi√≥n',
                    text: 'No se pudo conectar con el servidor. Intenta nuevamente.',
                    confirmButtonText: 'Reintentar',
                    confirmButtonColor: '#d33'
                });

                $button.prop('disabled', false);
            }
        });
    }

    // üîπ INICIALIZAR contadores al cargar la p√°gina
    inicializarContadoresDescripcion();

    });
</script>

{% endblock %}
