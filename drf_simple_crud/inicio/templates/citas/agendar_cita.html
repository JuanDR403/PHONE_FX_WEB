{% extends "base.html" %}
{% load static %}
{% block content %}
{% if rol == "admin" or rol == "cliente" %}

<style>
    .form-container {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 40px;
        margin: 20px 0;
        border: 1px solid var(--border-color);
        box-shadow: 0 20px 40px var(--shadow-color);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .form-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent-purple) 0%, var(--accent-green) 50%, var(--accent-yellow) 100%);
    }

    .form-header {
        text-align: center;
        margin-bottom: 40px;
        position: relative;
    }

    .form-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 2.5rem;
        background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-green) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .form-subtitle {
        color: var(--text-secondary);
        font-family: 'Poppins', sans-serif;
        font-weight: 300;
        font-size: 1.1rem;
    }

    .form-card {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 30px;
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }

    .form-card:hover {
        background: var(--bg-secondary);
        border-color: var(--accent-purple);
        transform: translateY(-2px);
    }

    .form-label {
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
    }

    .form-label i {
        margin-right: 10px;
        font-size: 1.2rem;
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* ESTILOS MEJORADOS PARA TODOS LOS SELECTS */
    .form-select {
        background: var(--search-bg) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 12px !important;
        color: var(--text-primary) !important;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        padding: 15px 20px !important;
        transition: all 0.3s ease;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        cursor: pointer;
        width: 100%;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23E040FB' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: calc(100% - 20px) center !important;
        background-size: 16px 16px !important;
        position: relative;
        z-index: 2;
    }

    .form-select:focus {
        background: var(--bg-card) !important;
        border-color: var(--accent-purple) !important;
        box-shadow: 0 0 0 3px rgba(224, 64, 251, 0.1) !important;
        color: var(--text-primary) !important;
        outline: none;
    }

    .form-select:hover {
        border-color: var(--accent-purple) !important;
        background: var(--bg-secondary) !important;
    }

    /* ESTILOS PARA LAS OPCIONES DESPLEGADAS */
    .form-select option {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
        padding: 12px 15px !important;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95rem;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .form-select option:hover {
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
        color: #000000 !important;
        font-weight: 600;
    }

    .form-select option:checked {
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
        color: #000000 !important;
        font-weight: 600;
    }

    .form-select option:focus {
        background: rgba(224, 64, 251, 0.3) !important;
        color: var(--text-primary) !important;
    }

    /* Estilos espec√≠ficos para el dropdown del select */
    .form-select:focus option:checked {
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
        color: #000000 !important;
    }

    /* Mejoras para el desplegable en diferentes navegadores */
    select.form-select::-ms-expand {
        display: none;
    }

    /* Contenedor para mejorar el estilo del select */
    .select-wrapper {
        position: relative;
        width: 100%;
    }

    .select-wrapper::after {
        content: '';
        position: absolute;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        width: 10px;
        height: 10px;
        border-right: 2px solid var(--accent-purple);
        border-bottom: 2px solid var(--accent-purple);
        transform: translateY(-50%) rotate(45deg);
        pointer-events: none;
        transition: transform 0.3s ease;
    }

    .form-select:focus + .select-wrapper::after {
        transform: translateY(-50%) rotate(-135deg);
    }

    .form-input, .form-textarea {
        background: var(--search-bg) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 12px !important;
        color: var(--text-primary) !important;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        padding: 15px 20px !important;
        transition: all 0.3s ease;
    }

    .form-input:focus, .form-textarea:focus {
        background: var(--bg-card) !important;
        border-color: var(--accent-purple) !important;
        box-shadow: 0 0 0 3px rgba(224, 64, 251, 0.1) !important;
        color: var(--text-primary) !important;
        outline: none;
    }

    .form-input::placeholder, .form-textarea::placeholder {
        color: var(--text-muted) !important;
    }

    .form-text {
        color: var(--text-muted) !important;
        font-family: 'Poppins', sans-serif;
        font-size: 0.9rem;
        margin-top: 8px;
        display: flex;
        align-items: center;
    }

    .form-text i {
        margin-right: 6px;
        color: var(--accent-green);
    }

    .char-counter {
        font-family: 'Poppins', sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-green) 100%);
        border: none;
        border-radius: 12px;
        padding: 15px 30px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1.1rem;
        color: #000000;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(224, 64, 251, 0.3);
    }

    .btn-primary-custom:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(224, 64, 251, 0.4);
        color: #000000;
    }

    .btn-secondary-custom {
        background: var(--search-bg);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 15px 30px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    .btn-secondary-custom:hover {
        background: var(--bg-card);
        border-color: var(--accent-purple);
        color: var(--text-primary);
        transform: translateY(-2px);
    }

    .link-custom {
        color: var(--accent-green) !important;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
    }

    .link-custom:hover {
        color: rgba(145, 255, 182, 0.8) !important;
        text-decoration: underline;
    }

    .modal-custom .modal-content {
        background: var(--bg-card);
        border-radius: 20px;
        border: 1px solid var(--border-color);
    }

    .modal-custom .modal-header {
        border-bottom: 1px solid var(--border-color);
        background: var(--search-bg);
    }

    .modal-custom .modal-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-green) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .alert-custom {
        background: var(--success-bg);
        border: 1px solid var(--accent-green);
        border-radius: 12px;
        color: var(--accent-green);
        font-family: 'Poppins', sans-serif;
    }

    .grid-2-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    /* Estados de validaci√≥n */
    .is-invalid {
        border-color: #FF7F7F !important;
        box-shadow: 0 0 0 3px rgba(255, 127, 127, 0.1) !important;
    }

    .is-valid {
        border-color: var(--accent-green) !important;
        box-shadow: 0 0 0 3px rgba(145, 255, 182, 0.1) !important;
    }

    /* Estilos adicionales para mejorar la experiencia del select */
    .form-group-select {
        position: relative;
    }

    /* Efecto de sombra para el dropdown */
    .form-select:focus {
        position: relative;
        z-index: 1000;
    }

    /* Mejora visual para opciones agrupadas */
    .form-select optgroup {
        background: var(--bg-secondary) !important;
        color: var(--accent-purple) !important;
        font-weight: 600;
        font-family: 'Poppins', sans-serif;
        padding: 10px;
    }

    .form-select optgroup option {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
        padding-left: 20px !important;
    }

    /* Estilos espec√≠ficos para modo claro */
    [data-theme="light"] .form-container {
        box-shadow: 0 10px 30px var(--shadow-color);
    }

    [data-theme="light"] .form-card:hover {
        box-shadow: 0 8px 25px var(--shadow-color);
    }

    [data-theme="light"] .btn-primary-custom {
        color: #000000;
    }

    [data-theme="light"] .btn-primary-custom:hover {
        color: #000000;
    }

    [data-theme="light"] .modal-custom .modal-header {
        background: var(--bg-secondary);
    }

    @media (max-width: 768px) {
        .form-container {
            padding: 25px;
            margin: 10px;
        }

        .form-title {
            font-size: 2rem;
        }

        .grid-2-col {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .btn-primary-custom,
        .btn-secondary-custom {
            width: 100%;
            margin-bottom: 10px;
        }
    }
</style>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <div class="form-container">
                <div class="form-header">
                    <h1 class="form-title">
                        <i class="fas fa-calendar-plus me-3"></i>
                        Agendar Nueva Cita
                    </h1>
                    <p class="form-subtitle">Programa tu cita de mantenimiento y reparaci√≥n</p>
                </div>

                <form method="POST" id="form-cita">
                    {% csrf_token %}

                    <!-- Informaci√≥n Principal -->
                    <div class="form-card">
                        <h3 class="mb-4" style="font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-info-circle me-2" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                            Informaci√≥n Principal
                        </h3>

                        <div class="grid-2-col">
                            <div class="form-group-select">
                                <label class="form-label">
                                    <i class="fas fa-user-tie"></i>
                                    Asesor
                                </label>
                                <div class="select-wrapper">
                                    {{ form.asesor }}
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Selecciona el asesor que atender√° tu cita
                                </div>
                            </div>

                            <div class="form-group-select">
                                <label class="form-label">
                                    <i class="fas fa-mobile-alt"></i>
                                    Dispositivo
                                </label>
                                <div class="select-wrapper">
                                    <select name="dispositivo" class="form-select" required id="id_dispositivo">
                                        <option value="">Selecciona un dispositivo</option>
                                        {% for dispositivo in form.dispositivo.field.queryset %}
                                            <option value="{{ dispositivo.iddispositivo }}">{{ dispositivo.marca }} {{ dispositivo.modelo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    <a href="#" class="link-custom" data-bs-toggle="modal" data-bs-target="#modalDispositivo">
                                        <i class="fas fa-plus-circle me-1"></i>¬øNo encuentras tu dispositivo? Registrar nuevo
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fecha y Hora -->
                    <div class="form-card">
                        <h3 class="mb-4" style="font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-clock me-2" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                            Fecha y Hora
                        </h3>

                        <div class="grid-2-col">
                            <div>
                                <label class="form-label">
                                    <i class="fas fa-calendar-day"></i>
                                    Fecha de la Cita
                                </label>
                                {{ form.fecha_cita }}
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Selecciona una fecha futura (m√≠nimo ma√±ana)
                                </div>
                            </div>

                            <div class="form-group-select">
                                <label class="form-label">
                                    <i class="fas fa-clock"></i>
                                    Hora de la Cita
                                </label>
                                <div class="select-wrapper">
                                    <select name="hora_cita" class="form-select" required id="id_hora_cita">
                                        <option value="">Selecciona una hora</option>
                                        <option value="08:00">8:00 AM</option>
                                        <option value="08:30">8:30 AM</option>
                                        <option value="09:00">9:00 AM</option>
                                        <option value="09:30">9:30 AM</option>
                                        <option value="10:00">10:00 AM</option>
                                        <option value="10:30">10:30 AM</option>
                                        <option value="11:00">11:00 AM</option>
                                        <option value="11:30">11:30 AM</option>
                                        <option value="12:00">12:00 PM</option>
                                        <option value="12:30">12:30 PM</option>
                                        <option value="13:00">1:00 PM</option>
                                        <option value="13:30">1:30 PM</option>
                                        <option value="14:00">2:00 PM</option>
                                    </select>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Horario disponible: 8:00 AM - 2:00 PM (cada 30 minutos)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Servicio y Observaciones -->
                    <div class="form-card">
                        <h3 class="mb-4" style="font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-tools me-2" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                            Detalles del Servicio
                        </h3>

                        <div class="mb-4 form-group-select">
                            <label class="form-label">
                                <i class="fas fa-tools"></i>
                                Tipo de Servicio
                            </label>
                            <div class="select-wrapper">
                                {{ form.tipo_servicio }}
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i>
                                Selecciona el tipo de servicio que requieres
                            </div>
                        </div>

                        <div>
                            <label class="form-label">
                                <i class="fas fa-sticky-note"></i>
                                Observaciones
                                <span style="color: var(--text-muted); font-weight: 400;">(Opcional)</span>
                            </label>
                            {{ form.observaciones }}
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Describe cualquier detalle adicional sobre tu dispositivo o problema
                                </div>
                                <span id="contador-observaciones" class="char-counter" style="color: var(--text-muted);">400 caracteres restantes</span>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="d-flex gap-3 pt-4 border-top" style="border-color: var(--border-color) !important; justify-content: center; flex-wrap;">
                        <button type="submit" class="btn btn-primary-custom" id="btn-agendar-cita">
                            <i class="fas fa-calendar-check me-2"></i>Agendar Cita
                        </button>
                        <a href="{% url 'inicio:home' %}" class="btn btn-secondary-custom">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para nuevo dispositivo -->
<div class="modal fade modal-custom" id="modalDispositivo" tabindex="-1" aria-labelledby="modalDispositivoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDispositivoLabel">
                    <i class="fas fa-plus-circle me-2"></i>
                    Registrar Nuevo Dispositivo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="form-dispositivo-modal" method="post" action="{% url 'citas:agregar_dispositivo' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="grid-2-col">
                        <div class="form-group-select">
                            <label class="form-label">
                                <i class="fas fa-tag"></i>
                                Marca
                            </label>
                            <div class="select-wrapper">
                                {{ dispositivo_form.marca }}
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i>
                                Selecciona la marca de tu dispositivo
                            </div>
                        </div>

                        <div>
                            <label class="form-label">
                                <i class="fas fa-mobile"></i>
                                Modelo
                            </label>
                            <input type="hidden" name="modelo" id="id_modelo_real" required>
                            <select class="form-select" id="id_modelo_ui" disabled required>
                                <option value="">Primero selecciona una marca</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i>
                                El modelo se habilita al seleccionar una marca
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label">
                            <i class="fas fa-barcode"></i>
                            N√∫mero de Serie
                            <span style="color: var(--text-muted); font-weight: 400;">(Opcional)</span>
                        </label>
                        {{ dispositivo_form.numero_serie }}
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i>
                            Ingresa el n√∫mero de serie si lo conoces
                        </div>
                    </div>

                    <div class="alert alert-custom mt-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-3 fa-lg"></i>
                            <div>
                                <strong style="color: var(--accent-green);">Informaci√≥n importante:</strong>
                                <p class="mb-0 small" style="color: var(--accent-green);">La fecha de registro se asignar√° autom√°ticamente al momento de guardar.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-custom" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary-custom" id="btn-guardar-dispositivo">
                        <i class="fas fa-save me-2"></i>Guardar Dispositivo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts mejorados con el mismo dise√±o -->
<script>
// Funci√≥n para obtener estilos del tema actual
function getThemeStyles() {
    const styles = getComputedStyle(document.documentElement);
    return {
        background: styles.getPropertyValue('--bg-primary').trim(),
        color: styles.getPropertyValue('--text-primary').trim(),
        borderColor: styles.getPropertyValue('--border-color').trim()
    };
}

// Evitar ejecuci√≥n m√∫ltiple
if (window.modalScriptEjecutado) {
    console.log('‚ÑπÔ∏è Script ya ejecutado, saliendo...');
} else {
    window.modalScriptEjecutado = true;

    console.log('=== INICIANDO CONFIGURACI√ìN MODAL ===');

    // Datos de modelos por marca (COMPLETO)
    const MODELOS_POR_MARCA = {
        'Apple': ['iPhone 15 Pro Max', 'iPhone 15 Pro', 'iPhone 15', 'iPhone 14 Pro Max', 'iPhone 14 Pro', 'iPhone 14', 'iPhone 13', 'iPhone 12', 'iPhone 11', 'iPhone SE', 'iPad Pro', 'iPad Air', 'iPad Mini', 'MacBook Pro', 'MacBook Air', 'iMac', 'Apple Watch'],
        'Samsung': ['Galaxy S24 Ultra', 'Galaxy S24+', 'Galaxy S24', 'Galaxy S23 Ultra', 'Galaxy S23+', 'Galaxy S23', 'Galaxy Z Fold5', 'Galaxy Z Flip5', 'Galaxy A54', 'Galaxy A34', 'Galaxy A14', 'Galaxy Tab S9', 'Galaxy Watch6'],
        'Xiaomi': ['Redmi Note 13 Pro+', 'Redmi Note 13 Pro', 'Redmi Note 13', 'Xiaomi 13T Pro', 'Xiaomi 13T', 'Xiaomi 13', 'Poco X6 Pro', 'Poco X6', 'Poco M6 Pro', 'Redmi 12'],
        'OPPO': ['Find X6 Pro', 'Reno 11 Pro', 'Reno 11', 'A98', 'A78', 'A58'],
        'Vivo': ['X100 Pro', 'X100', 'V29', 'V27', 'Y100', 'Y27'],
        'Huawei': ['P60 Pro', 'P60', 'Mate 60 Pro', 'Mate 60', 'Nova 11', 'Enjoy 70'],
        'Realme': ['GT5 Pro', 'GT5', '11 Pro+', '11 Pro', '11', 'C55'],
        'Honor': ['Magic5 Pro', 'Magic5', 'X9a', 'X8a', 'X7'],
        'OnePlus': ['12', '11', 'Nord 3', 'Nord CE 3', 'Nord N30'],
        'Motorola': ['Edge 40 Pro', 'Edge 40', 'G84', 'G54', 'E13'],
        'Sony': ['Xperia 1 V', 'Xperia 5 V', 'Xperia 10 V'],
        'Nokia': ['G42', 'C32', 'C22', 'C12'],
        'Infinix': ['Note 30 Pro', 'Note 30', 'Hot 30', 'Smart 8'],
        'Tecno': ['Camon 20 Pro', 'Camon 20', 'Pova 5', 'Spark 10'],
        'Google': ['Pixel 8 Pro', 'Pixel 8', 'Pixel 7a', 'Pixel 7 Pro', 'Pixel 7', 'Pixel 6a', 'Pixel Fold', 'Pixel Tablet']
    };

    // Funci√≥n para aplicar estilos a los selects
    function aplicarEstilosSelects() {
        console.log('üé® Aplicando estilos a los selects...');

        const allSelects = document.querySelectorAll('select');
        allSelects.forEach(select => {
            // Aplicar clase form-select si no la tiene
            if (!select.classList.contains('form-select')) {
                select.classList.add('form-select');
            }

            // Agregar opci√≥n por defecto si no existe
            if (!select.querySelector('option[value=""]') && select.required) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Selecciona una opci√≥n';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.insertBefore(defaultOption, select.firstChild);
            }

            // Mejorar la experiencia visual al cambiar opciones
            select.addEventListener('change', function() {
                if (this.value) {
                    this.style.borderColor = 'var(--accent-green)';
                    setTimeout(() => {
                        this.style.borderColor = 'var(--border-color)';
                    }, 1000);
                }
            });

            // Agregar wrapper para mejor estilo
            if (!select.parentElement.classList.contains('select-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'select-wrapper';
                select.parentNode.insertBefore(wrapper, select);
                wrapper.appendChild(select);
            }
        });

        console.log(`‚úÖ Estilos aplicados a ${allSelects.length} selects`);
    }

    // Funci√≥n para actualizar modelos
    function actualizarModelos(marca) {
        console.log('üîß Actualizando modelos para:', marca);

        const selectModeloUI = document.getElementById('id_modelo_ui');
        const inputModeloReal = document.getElementById('id_modelo_real');

        if (!selectModeloUI || !inputModeloReal) {
            console.error('‚ùå No se encontraron los elementos de modelo');
            return;
        }

        // Limpiar opciones
        selectModeloUI.innerHTML = '';
        inputModeloReal.value = '';

        const modelos = MODELOS_POR_MARCA[marca] || [];
        console.log(`üì± Encontrados ${modelos.length} modelos para ${marca}`);

        if (modelos.length > 0) {
            selectModeloUI.disabled = false;

            // Agregar opci√≥n por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecciona un modelo';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            selectModeloUI.appendChild(defaultOption);

            // Agregar modelos
            modelos.forEach(modelo => {
                const option = document.createElement('option');
                option.value = modelo;
                option.textContent = modelo;
                selectModeloUI.appendChild(option);
            });

            // Aplicar estilos al select actualizado
            aplicarEstilosSelects();
            console.log('‚úÖ Modelos actualizados correctamente');
        } else {
            selectModeloUI.disabled = true;
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Primero selecciona una marca';
            selectModeloUI.appendChild(option);
        }
    }

    // Configurar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM listo - configurando modal...');

        // Aplicar estilos iniciales
        aplicarEstilosSelects();

        const modal = document.getElementById('modalDispositivo');
        if (modal) {
            modal.addEventListener('shown.bs.modal', function() {
                console.log('üìã Modal abierto - configurando event listeners...');

                // Re-aplicar estilos en el modal
                aplicarEstilosSelects();

                const selectMarca = this.querySelector('select[name="marca"]');
                if (selectMarca) {
                    selectMarca.addEventListener('change', function(e) {
                        console.log('üîÑ Cambio en select marca:', e.target.value);
                        actualizarModelos(e.target.value);
                    });
                    console.log('‚úÖ Event listener agregado al select de marca');
                }

                // Configurar cambio en el select UI
                const selectModeloUI = document.getElementById('id_modelo_ui');
                if (selectModeloUI) {
                    selectModeloUI.addEventListener('change', function(e) {
                        const inputModeloReal = document.getElementById('id_modelo_real');
                        inputModeloReal.value = e.target.value;
                        console.log('üìù Modelo seleccionado:', e.target.value);
                    });
                }
            });

            // Tambi√©n aplicar estilos cuando el modal se cierra y se vuelve a abrir
            modal.addEventListener('hidden.bs.modal', function() {
                // Resetear el formulario del modal
                const form = document.getElementById('form-dispositivo-modal');
                if (form) {
                    form.reset();
                }

                // Resetear el select de modelos
                const selectModeloUI = document.getElementById('id_modelo_ui');
                if (selectModeloUI) {
                    selectModeloUI.innerHTML = '<option value="">Primero selecciona una marca</option>';
                    selectModeloUI.disabled = true;
                }
            });
        }

        // Configurar el env√≠o del formulario de dispositivo
        const formDispositivo = document.getElementById('form-dispositivo-modal');
        if (formDispositivo) {
            formDispositivo.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('üì§ Enviando formulario de dispositivo...');

                // Validaciones
                const marca = document.querySelector('#modalDispositivo select[name="marca"]')?.value;
                const modelo = document.getElementById('id_modelo_real')?.value;

                if (!marca) {
                    const theme = getThemeStyles();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Marca Requerida',
                        text: 'Por favor selecciona una marca para tu dispositivo.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#ffc107',
                        background: theme.background,
                        color: theme.color
                    });
                    return;
                }

                if (!modelo) {
                    const theme = getThemeStyles();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Modelo Requerido',
                        text: 'Por favor selecciona un modelo para tu dispositivo.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#ffc107',
                        background: theme.background,
                        color: theme.color
                    });
                    return;
                }

                console.log('üì¶ Datos a enviar - Marca:', marca, 'Modelo:', modelo);

                const theme = getThemeStyles();

                // Mostrar loading
                Swal.fire({
                    title: 'Registrando Dispositivo...',
                    text: 'Por favor espera un momento',
                    allowOutsideClick: false,
                    background: theme.background,
                    color: theme.color,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Enviar datos
                const formData = new FormData(this);
                formData.set('modelo', modelo);

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    Swal.close();

                    if (data.success) {
                        console.log('‚úÖ Dispositivo guardado exitosamente');

                        // Agregar al select principal
                        const selectPrincipal = document.getElementById('id_dispositivo');
                        if (selectPrincipal) {
                            const option = document.createElement('option');
                            option.value = data.dispositivo_id;
                            option.textContent = data.dispositivo_text;
                            option.selected = true;
                            selectPrincipal.appendChild(option);

                            // Aplicar estilos al select actualizado
                            aplicarEstilosSelects();
                        }

                        // Cerrar modal de dispositivo
                        const modalDispositivo = bootstrap.Modal.getInstance(document.getElementById('modalDispositivo'));
                        if (modalDispositivo) modalDispositivo.hide();

                        const theme = getThemeStyles();

                        // Mostrar SweetAlert de √©xito
                        Swal.fire({
                            icon: 'success',
                            title: '¬°Dispositivo Registrado!',
                            html: `
                                <div class="text-center">
                                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                                    <p>Dispositivo registrado correctamente.</p>
                                    <p class="text-muted small">Se ha agregado a la lista de dispositivos.</p>
                                </div>
                            `,
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            background: theme.background,
                            color: theme.color
                        });

                    } else {
                        console.error('‚ùå Error al guardar:', data.errors);

                        const theme = getThemeStyles();

                        // SweetAlert para errores
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al Registrar',
                            text: 'Hubo un error al guardar el dispositivo. Por favor, verifica los datos.',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#d33',
                            background: theme.background,
                            color: theme.color
                        });
                    }
                })
                .catch(error => {
                    Swal.close();
                    console.error('üí• Error en la solicitud:', error);
                    const theme = getThemeStyles();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Conexi√≥n',
                        text: 'No se pudo registrar el dispositivo. Intenta nuevamente.',
                        confirmButtonText: 'Reintentar',
                        confirmButtonColor: '#d33',
                        background: theme.background,
                        color: theme.color
                    });
                });
            });
        }
    });

    console.log('‚úÖ Script completamente configurado');
}
</script>

<!-- Script para contador de caracteres en observaciones -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textareaObservaciones = document.querySelector('textarea[name="observaciones"]');
    const contadorObservaciones = document.getElementById('contador-observaciones');

    const LIMITE_OBSERVACIONES = 400;

    function actualizarContadorObservaciones() {
        if (!textareaObservaciones || !contadorObservaciones) return;

        const caracteresActuales = textareaObservaciones.value.length;
        const caracteresRestantes = LIMITE_OBSERVACIONES - caracteresActuales;

        contadorObservaciones.textContent = `${caracteresRestantes} caracteres restantes`;

        // Cambiar color seg√∫n los caracteres restantes
        if (caracteresRestantes <= 0) {
            contadorObservaciones.style.color = '#FF7F7F';
            contadorObservaciones.style.fontWeight = 'bold';
            textareaObservaciones.classList.add('is-invalid');
        } else if (caracteresRestantes <= 50) {
            contadorObservaciones.style.color = '#FFA500';
            textareaObservaciones.classList.remove('is-invalid');
        } else {
            contadorObservaciones.style.color = 'var(--text-muted)';
            textareaObservaciones.classList.remove('is-invalid');
        }
    }

    if (textareaObservaciones && contadorObservaciones) {
        textareaObservaciones.addEventListener('input', function() {
            // Limitar caracteres en tiempo real
            if (this.value.length > LIMITE_OBSERVACIONES) {
                this.value = this.value.substring(0, LIMITE_OBSERVACIONES);
            }
            actualizarContadorObservaciones();
        });

        // Inicializar con el valor actual
        actualizarContadorObservaciones();
    }
});
</script>

<!-- Scripts existentes mejorados (manteniendo la funcionalidad) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Funci√≥n para obtener el token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Variable global para el timeout
let fechaTimeout = null;

function configurarFormularioCita() {
    const formCita = document.getElementById('form-cita');

    if (formCita) {
        formCita.addEventListener('submit', function(e) {
            e.preventDefault();

            // Validar campos requeridos
            const asesor = document.querySelector('select[name="asesor"]').value;
            const dispositivo = document.getElementById('id_dispositivo').value;
            const fecha = document.querySelector('input[name="fecha_cita"]').value;
            const hora = document.querySelector('select[name="hora_cita"]').value;
            const tipoServicio = document.querySelector('select[name="tipo_servicio"]').value;

            let errores = [];

            if (!asesor) errores.push('Debes seleccionar un asesor.');
            if (!dispositivo) errores.push('Debes seleccionar un dispositivo.');
            if (!fecha) errores.push('Debes seleccionar una fecha.');
            if (!hora) errores.push('Debes seleccionar una hora.');
            if (!tipoServicio) errores.push('Debes seleccionar un tipo de servicio.');

            // Agregar validaciones de formato y l√≥gica
            const erroresValidacion = validarFormularioCompleto();
            errores = errores.concat(erroresValidacion);

            if (errores.length > 0) {
                const theme = getThemeStyles();
                Swal.fire({
                    icon: 'error',
                    title: 'Error en el Formulario',
                    html: `
                        <div class="text-start">
                            <p>Por favor corrige los siguientes errores:</p>
                            <ul class="small">
                                ${errores.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    `,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545',
                    background: theme.background,
                    color: theme.color
                });
                return;
            }

            // Verificar disponibilidad de la fecha antes de mostrar confirmaci√≥n
            const fechaInput = document.querySelector('input[name="fecha_cita"]');
            if (fechaInput && fechaInput.value) {
                const theme = getThemeStyles();

                // Mostrar loading mientras verifica disponibilidad
                Swal.fire({
                    title: 'Verificando disponibilidad...',
                    text: 'Por favor espera un momento',
                    allowOutsideClick: false,
                    background: theme.background,
                    color: theme.color,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                fetch(`/citas/verificar-fecha/?fecha=${fechaInput.value}`)
                    .then(response => response.json())
                    .then(data => {
                        Swal.close();

                        if (!data.disponible) {
                            mostrarError('Ya existe una cita agendada para esta fecha. Por favor selecciona otra fecha.');
                            return;
                        }

                        // Si est√° disponible, mostrar confirmaci√≥n
                        mostrarConfirmacionCita();
                    })
                    .catch(error => {
                        Swal.close();
                        console.error('Error verificando fecha:', error);
                        // Si hay error en la verificaci√≥n, continuar con confirmaci√≥n
                        mostrarConfirmacionCita();
                    });
            } else {
                mostrarConfirmacionCita();
            }

            function mostrarConfirmacionCita() {
                // Obtener datos para el resumen
                const asesorSelect = document.querySelector('select[name="asesor"]');
                const asesorText = asesorSelect.options[asesorSelect.selectedIndex].text;
                const dispositivoSelect = document.getElementById('id_dispositivo');
                const dispositivoText = dispositivoSelect.options[dispositivoSelect.selectedIndex].text;
                const horaSelect = document.querySelector('select[name="hora_cita"]');
                const horaText = horaSelect.options[horaSelect.selectedIndex].text;

                const theme = getThemeStyles();

                // Mostrar confirmaci√≥n con resumen
                Swal.fire({
                    title: '¬øConfirmar Cita?',
                    html: `
                        <div class="text-start">
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Asesor:</strong></p>
                                    <p><strong>Dispositivo:</strong></p>
                                    <p><strong>Fecha:</strong></p>
                                    <p><strong>Hora:</strong></p>
                                    <p><strong>Servicio:</strong></p>
                                </div>
                                <div class="col-6">
                                    <p>${asesorText}</p>
                                    <p>${dispositivoText}</p>
                                    <p>${fecha}</p>
                                    <p>${horaText}</p>
                                    <p>${tipoServicio}</p>
                                </div>
                            </div>
                            <p class="mt-3 text-muted border-top pt-2">¬øEst√°s seguro de que quieres agendar esta cita?</p>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, Agendar Cita',
                    cancelButtonText: 'Revisar Datos',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    backdrop: true,
                    width: '600px',
                    background: theme.background,
                    color: theme.color
                }).then((result) => {
                    if (result.isConfirmed) {
                        enviarFormularioCita(formCita);
                    }
                });
            }
        });
    }
}

function enviarFormularioCita(form) {
    const theme = getThemeStyles();

    // Mostrar loading
    Swal.fire({
        title: 'Agendando cita...',
        text: 'Por favor espera un momento',
        allowOutsideClick: false,
        background: theme.background,
        color: theme.color,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    const formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => {
        if (response.redirected) {
            // √âxito - redirecci√≥n
            Swal.fire({
                icon: 'success',
                title: '¬°Cita Agendada!',
                html: `
                    <div class="text-center">
                        <i class="fas fa-calendar-check text-success mb-3" style="font-size: 3rem;"></i>
                        <p class="mb-2">Tu cita se ha agendado correctamente.</p>
                        <p class="text-muted small">Ser√°s redirigido al inicio...</p>
                    </div>
                `,
                showConfirmButton: false,
                timer: 2500,
                timerProgressBar: true,
                background: theme.background,
                color: theme.color,
                didClose: () => {
                    window.location.href = response.url;
                }
            });
        } else {
            return response.text().then(text => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Validaci√≥n',
                    text: 'Por favor verifica los datos del formulario',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545',
                    background: theme.background,
                    color: theme.color
                });
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const theme = getThemeStyles();
        Swal.fire({
            icon: 'error',
            title: 'Error de Conexi√≥n',
            text: 'No se pudo agendar la cita. Intenta nuevamente.',
            confirmButtonText: 'Reintentar',
            confirmButtonColor: '#dc3545',
            background: theme.background,
            color: theme.color
        });
    });
}

// Configurar validaciones de fecha y hora
function configurarValidacionesCita() {
    const fechaInput = document.querySelector('input[name="fecha_cita"]');
    const horaInput = document.querySelector('select[name="hora_cita"]');

    if (fechaInput) {
        // Establecer fecha m√≠nima (ma√±ana)
        const hoy = new Date();
        const manana = new Date(hoy);
        manana.setDate(hoy.getDate() + 1);
        const fechaMinima = manana.toISOString().split('T')[0];
        fechaInput.min = fechaMinima;

        // ELIMINAR validaci√≥n en tiempo real del input
        // Solo validar cuando el usuario termina de interactuar

        // Validaci√≥n solo cuando se selecciona del datepicker
        fechaInput.addEventListener('change', function() {
            // Peque√±o delay para asegurar que el valor est√© estable
            setTimeout(() => {
                if (this.value && this.value.length === 10) {
                    validarFechaCompleta();
                }
            }, 100);
        });

        // Validaci√≥n cuando pierde el foco (solo si tiene valor completo)
        fechaInput.addEventListener('blur', function() {
            if (this.value && this.value.length === 10) {
                validarFechaCompleta();
            }
        });
    }

    if (horaInput) {
        // Como es un select, no necesita validaci√≥n en tiempo real
        // Los minutos ya est√°n limitados a 00 y 30 en las opciones
    }
}

// Funci√≥n para validar fecha solo cuando est√° completa
function validarFechaCompleta() {
    const fechaInput = document.querySelector('input[name="fecha_cita"]');

    if (!fechaInput || !fechaInput.value || fechaInput.value.length !== 10) {
        return true; // No validar si est√° vac√≠a o incompleta
    }

    // Verificar que sea una fecha real (no "0002-01-01" o similares)
    const fechaValue = fechaInput.value;
    const [year, month, day] = fechaValue.split('-').map(Number);

    // Si el a√±o es menor a 1000, probablemente es un error de escritura
    if (year < 1000) {
        return true; // No validar a√±os como 0002, 0025, etc.
    }

    try {
        const fechaSeleccionada = new Date(fechaValue);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        if (isNaN(fechaSeleccionada.getTime())) {
            return true; // Fecha inv√°lida, pero no mostrar error
        }

        if (fechaSeleccionada < hoy) {
            mostrarError('No se pueden agendar citas en fechas pasadas.');
            fechaInput.value = ''; // Limpiar el campo
            return false;
        } else if (fechaSeleccionada.getTime() === hoy.getTime()) {
            mostrarError('Las citas deben agendarse con al menos un d√≠a de anticipaci√≥n.');
            fechaInput.value = ''; // Limpiar el campo
            return false;
        } else {
            // Verificar disponibilidad solo si la fecha es v√°lida y futura
            verificarDisponibilidadFecha(fechaInput.value);
            return true;
        }
    } catch (error) {
        return true; // Si hay error, no validar
    }
}

// Funci√≥n para verificar disponibilidad
function verificarDisponibilidadFecha(fecha) {
    try {
        const fechaObj = new Date(fecha);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        if (fechaObj <= hoy || isNaN(fechaObj.getTime())) {
            return;
        }

        fetch(`/citas/verificar-fecha/?fecha=${fecha}`)
            .then(response => response.json())
            .then(data => {
                if (!data.disponible) {
                    mostrarError('Ya existe una cita agendada para esta fecha. Por favor selecciona otra fecha.');
                }
            })
            .catch(error => console.error('Error verificando fecha:', error));
    } catch (error) {
        console.error('Error en verificaci√≥n de fecha:', error);
    }
}

// Validaci√≥n final antes de enviar el formulario
function validarFormularioCompleto() {
    const fechaInput = document.querySelector('input[name="fecha_cita"]');
    const horaInput = document.querySelector('select[name="hora_cita"]');

    let errores = [];

    // Validar fecha
    if (fechaInput && fechaInput.value) {
        try {
            const fechaSeleccionada = new Date(fechaInput.value);
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            if (isNaN(fechaSeleccionada.getTime())) {
                errores.push('La fecha ingresada no es v√°lida.');
            } else if (fechaSeleccionada < hoy) {
                errores.push('No se pueden agendar citas en fechas pasadas.');
            } else if (fechaSeleccionada.getTime() === hoy.getTime()) {
                errores.push('Las citas deben agendarse con al menos un d√≠a de anticipaci√≥n.');
            }
        } catch (error) {
            errores.push('La fecha ingresada no es v√°lida.');
        }
    }

    // Validar hora (para select, ya est√° validado por las opciones)
    if (horaInput && !horaInput.value) {
        errores.push('Debes seleccionar una hora para la cita.');
    }

    return errores;
}

function mostrarError(mensaje) {
    const theme = getThemeStyles();
    Swal.fire({
        icon: 'warning',
        title: 'Validaci√≥n',
        text: mensaje,
        confirmButtonText: 'Entendido',
        confirmButtonColor: '#ffc107',
        background: theme.background,
        color: theme.color
    });
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    configurarValidacionesCita();
    configurarFormularioCita();
});

// Mostrar mensajes de Django
function mostrarMensajes() {
    {% if messages %}
        {% for message in messages %}
            const theme = getThemeStyles();
            {% if message.tags == 'error' %}
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Permisos',
                    html: `{{ message|safe }}`,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545',
                    backdrop: true,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    background: theme.background,
                    color: theme.color
                });
            {% elif message.tags == 'success' %}
                Swal.fire({
                    icon: 'success',
                    title: '¬°√âxito!',
                    text: '{{ message }}',
                    confirmButtonText: 'Aceptar',
                    confirmButtonColor: '#28a745',
                    timer: 3000,
                    timerProgressBar: true,
                    background: theme.background,
                    color: theme.color
                });
            {% endif %}
        {% endfor %}
    {% endif %}
}

document.addEventListener('DOMContentLoaded', mostrarMensajes);
</script>

{% else %}
<!-- Mensaje de acceso denegado con nuevo estilo -->
<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="form-container text-center">
            <i class="fas fa-ban mb-4" style="font-size: 4rem; background: linear-gradient(135deg, #FF7F7F, var(--accent-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
            <h3 class="form-title">Acceso Denegado</h3>
            <p class="form-subtitle">No tienes permisos para acceder a esta p√°gina. Solo usuarios con rol de Admin o Cliente pueden agendar citas.</p>
            <a href="{% url 'inicio:home' %}" class="btn btn-primary-custom mt-3">
                <i class="fas fa-home me-2"></i>Volver al Inicio
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}