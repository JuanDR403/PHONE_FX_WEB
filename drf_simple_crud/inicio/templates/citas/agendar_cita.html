{% extends "base.html" %}
{% load static %}
{% block content %}
{% if rol == "admin" or rol == "cliente" %}

<div class="row justify-content-center">
  <div class="col-12 col-md-10 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">
          <i class="fas fa-calendar-plus me-2"></i>
          Agendar Nueva Cita
        </h4>
      </div>
      <div class="card-body">
        <form method="POST" id="form-cita">
          {% csrf_token %}

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-user-tie text-primary me-2"></i>
                  Asesor
                </label>
                {{ form.asesor }}
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Selecciona el asesor que atender√° tu cita
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-mobile-alt text-primary me-2"></i>
                  Dispositivo
                </label>
                <select name="dispositivo" class="form-select" required id="id_dispositivo">
                  <option value="">Selecciona un dispositivo</option>
                  {% for dispositivo in form.dispositivo.field.queryset %}
                    <option value="{{ dispositivo.iddispositivo }}">{{ dispositivo.marca }} {{ dispositivo.modelo }}</option>
                  {% endfor %}
                </select>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  <a href="#" class="text-primary fw-bold" data-bs-toggle="modal" data-bs-target="#modalDispositivo">
                    <i class="fas fa-plus-circle me-1"></i>¬øNo encuentras tu dispositivo? Registrar nuevo
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-calendar-day text-primary me-2"></i>
                  Fecha de la Cita
                </label>
                {{ form.fecha_cita }}
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Selecciona una fecha futura (m√≠nimo ma√±ana)
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-clock text-primary me-2"></i>
                  Hora de la Cita
                </label>
                {{ form.hora_cita }}
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Horario disponible: 8:00 AM - 2:00 PM
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-tools text-primary me-2"></i>
              Tipo de Servicio
            </label>
            {{ form.tipo_servicio }}
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i>
              Selecciona el tipo de servicio que requieres
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold">
              <i class="fas fa-sticky-note text-primary me-2"></i>
              Observaciones
              <span class="text-muted fw-normal">(Opcional)</span>
            </label>
            {{ form.observaciones }}
            <div class="d-flex justify-content-between align-items-center mt-1">
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Describe cualquier detalle adicional sobre tu dispositivo o problema
              </div>
              <span id="contador-observaciones" class="text-muted small">400 caracteres restantes</span>
            </div>
          </div>

          <div class="d-flex gap-2 pt-3 border-top">
            <button type="submit" class="btn btn-primary btn-lg" id="btn-agendar-cita">
              <i class="fas fa-calendar-check me-2"></i>Agendar Cita
            </button>
            <a href="{% url 'inicio:home' %}" class="btn btn-secondary btn-lg">
              <i class="fas fa-times me-2"></i>Cancelar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para nuevo dispositivo -->
<div class="modal fade" id="modalDispositivo" tabindex="-1" aria-labelledby="modalDispositivoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalDispositivoLabel">
          <i class="fas fa-plus-circle me-2"></i>
          Registrar Nuevo Dispositivo
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="form-dispositivo-modal" method="post" action="{% url 'citas:agregar_dispositivo' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-tag text-primary me-2"></i>
                  Marca
                </label>
                {{ dispositivo_form.marca }}
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Selecciona la marca de tu dispositivo
                </div>
                <div class="invalid-feedback" id="error-marca"></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-mobile text-primary me-2"></i>
                  Modelo
                </label>
                <!-- Input hidden para el valor real -->
                <input type="hidden" name="modelo" id="id_modelo_real" required>
                <!-- Select solo para la UI -->
                <select class="form-select" id="id_modelo_ui" disabled required>
                  <option value="">Primero selecciona una marca</option>
                </select>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  El modelo se habilita al seleccionar una marca
                </div>
                <div class="invalid-feedback" id="error-modelo"></div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">
              <i class="fas fa-barcode text-primary me-2"></i>
              N√∫mero de Serie
              <span class="text-muted fw-normal">(Opcional)</span>
            </label>
            {{ dispositivo_form.numero_serie }}
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i>
              Ingresa el n√∫mero de serie si lo conoces
            </div>
            <div class="invalid-feedback" id="error-numero_serie"></div>
          </div>

          <div class="alert alert-info">
            <div class="d-flex align-items-center">
              <i class="fas fa-info-circle me-2 fa-lg"></i>
              <div>
                <strong>Informaci√≥n importante:</strong>
                <p class="mb-0 small">La fecha de registro se asignar√° autom√°ticamente al momento de guardar.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-primary" id="btn-guardar-dispositivo">
            <i class="fas fa-save me-2"></i>Guardar Dispositivo
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts mejorados con el mismo dise√±o -->
<script>
// Evitar ejecuci√≥n m√∫ltiple
if (window.modalScriptEjecutado) {
    console.log('‚ÑπÔ∏è Script ya ejecutado, saliendo...');
} else {
    window.modalScriptEjecutado = true;

    console.log('=== INICIANDO CONFIGURACI√ìN MODAL ===');

    // Datos de modelos por marca (COMPLETO)
    const MODELOS_POR_MARCA = {
        'Apple': ['iPhone 15 Pro Max', 'iPhone 15 Pro', 'iPhone 15', 'iPhone 14 Pro Max', 'iPhone 14 Pro', 'iPhone 14', 'iPhone 13', 'iPhone 12', 'iPhone 11', 'iPhone SE', 'iPad Pro', 'iPad Air', 'iPad Mini', 'MacBook Pro', 'MacBook Air', 'iMac', 'Apple Watch'],
        'Samsung': ['Galaxy S24 Ultra', 'Galaxy S24+', 'Galaxy S24', 'Galaxy S23 Ultra', 'Galaxy S23+', 'Galaxy S23', 'Galaxy Z Fold5', 'Galaxy Z Flip5', 'Galaxy A54', 'Galaxy A34', 'Galaxy A14', 'Galaxy Tab S9', 'Galaxy Watch6'],
        'Xiaomi': ['Redmi Note 13 Pro+', 'Redmi Note 13 Pro', 'Redmi Note 13', 'Xiaomi 13T Pro', 'Xiaomi 13T', 'Xiaomi 13', 'Poco X6 Pro', 'Poco X6', 'Poco M6 Pro', 'Redmi 12'],
        'OPPO': ['Find X6 Pro', 'Reno 11 Pro', 'Reno 11', 'A98', 'A78', 'A58'],
        'Vivo': ['X100 Pro', 'X100', 'V29', 'V27', 'Y100', 'Y27'],
        'Huawei': ['P60 Pro', 'P60', 'Mate 60 Pro', 'Mate 60', 'Nova 11', 'Enjoy 70'],
        'Realme': ['GT5 Pro', 'GT5', '11 Pro+', '11 Pro', '11', 'C55'],
        'Honor': ['Magic5 Pro', 'Magic5', 'X9a', 'X8a', 'X7'],
        'OnePlus': ['12', '11', 'Nord 3', 'Nord CE 3', 'Nord N30'],
        'Motorola': ['Edge 40 Pro', 'Edge 40', 'G84', 'G54', 'E13'],
        'Sony': ['Xperia 1 V', 'Xperia 5 V', 'Xperia 10 V'],
        'Nokia': ['G42', 'C32', 'C22', 'C12'],
        'Infinix': ['Note 30 Pro', 'Note 30', 'Hot 30', 'Smart 8'],
        'Tecno': ['Camon 20 Pro', 'Camon 20', 'Pova 5', 'Spark 10'],
        'Google': ['Pixel 8 Pro', 'Pixel 8', 'Pixel 7a', 'Pixel 7 Pro', 'Pixel 7', 'Pixel 6a', 'Pixel Fold', 'Pixel Tablet']
    };

    // Funci√≥n para actualizar modelos
    function actualizarModelos(marca) {
        console.log('üîß Actualizando modelos para:', marca);

        const selectModeloUI = document.getElementById('id_modelo_ui');
        const inputModeloReal = document.getElementById('id_modelo_real');

        if (!selectModeloUI || !inputModeloReal) {
            console.error('‚ùå No se encontraron los elementos de modelo');
            return;
        }

        // Limpiar opciones
        selectModeloUI.innerHTML = '';
        inputModeloReal.value = '';

        const modelos = MODELOS_POR_MARCA[marca] || [];
        console.log(`üì± Encontrados ${modelos.length} modelos para ${marca}`);

        if (modelos.length > 0) {
            selectModeloUI.disabled = false;

            // Agregar opci√≥n por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecciona un modelo';
            selectModeloUI.appendChild(defaultOption);

            // Agregar modelos
            modelos.forEach(modelo => {
                const option = document.createElement('option');
                option.value = modelo;
                option.textContent = modelo;
                selectModeloUI.appendChild(option);
            });

            console.log('‚úÖ Modelos actualizados correctamente');
        } else {
            selectModeloUI.disabled = true;
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Primero selecciona una marca';
            selectModeloUI.appendChild(option);
        }
    }

    // Configurar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM listo - configurando modal...');

        const modal = document.getElementById('modalDispositivo');
        if (modal) {
            modal.addEventListener('shown.bs.modal', function() {
                console.log('üìã Modal abierto - configurando event listeners...');

                const selectMarca = this.querySelector('select[name="marca"]');
                if (selectMarca) {
                    selectMarca.addEventListener('change', function(e) {
                        console.log('üîÑ Cambio en select marca:', e.target.value);
                        actualizarModelos(e.target.value);
                    });
                    console.log('‚úÖ Event listener agregado al select de marca');
                }

                // Configurar cambio en el select UI
                const selectModeloUI = document.getElementById('id_modelo_ui');
                if (selectModeloUI) {
                    selectModeloUI.addEventListener('change', function(e) {
                        const inputModeloReal = document.getElementById('id_modelo_real');
                        inputModeloReal.value = e.target.value;
                        console.log('üìù Modelo seleccionado:', e.target.value);
                    });
                }
            });
        }

        // Configurar el env√≠o del formulario de dispositivo
        const formDispositivo = document.getElementById('form-dispositivo-modal');
        if (formDispositivo) {
            formDispositivo.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('üì§ Enviando formulario de dispositivo...');

                // Validaciones
                const marca = document.querySelector('#modalDispositivo select[name="marca"]')?.value;
                const modelo = document.getElementById('id_modelo_real')?.value;

                if (!marca) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Marca Requerida',
                        text: 'Por favor selecciona una marca para tu dispositivo.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#ffc107'
                    });
                    return;
                }

                if (!modelo) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Modelo Requerido',
                        text: 'Por favor selecciona un modelo para tu dispositivo.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#ffc107'
                    });
                    return;
                }

                console.log('üì¶ Datos a enviar - Marca:', marca, 'Modelo:', modelo);

                // Mostrar loading
                Swal.fire({
                    title: 'Registrando Dispositivo...',
                    text: 'Por favor espera un momento',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Enviar datos
                const formData = new FormData(this);
                formData.set('modelo', modelo);

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    Swal.close();

                    if (data.success) {
                        console.log('‚úÖ Dispositivo guardado exitosamente');

                        // Agregar al select principal
                        const selectPrincipal = document.getElementById('id_dispositivo');
                        if (selectPrincipal) {
                            const option = document.createElement('option');
                            option.value = data.dispositivo_id;
                            option.textContent = data.dispositivo_text;
                            option.selected = true;
                            selectPrincipal.appendChild(option);
                        }

                        // Cerrar modal de dispositivo
                        const modalDispositivo = bootstrap.Modal.getInstance(document.getElementById('modalDispositivo'));
                        if (modalDispositivo) modalDispositivo.hide();

                        // Mostrar SweetAlert de √©xito
                        Swal.fire({
                            icon: 'success',
                            title: '¬°Dispositivo Registrado!',
                            html: `
                                <div class="text-center">
                                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                                    <p>Dispositivo registrado correctamente.</p>
                                    <p class="text-muted small">Se ha agregado a la lista de dispositivos.</p>
                                </div>
                            `,
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });

                        // Resetear formulario
                        this.reset();
                        const selectModeloReset = document.querySelector('#modalDispositivo select[name="modelo"]');
                        if (selectModeloReset) {
                            selectModeloReset.innerHTML = '<option value="">Primero selecciona una marca</option>';
                            selectModeloReset.disabled = true;
                        }

                    } else {
                        console.error('‚ùå Error al guardar:', data.errors);

                        // SweetAlert para errores
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al Registrar',
                            text: 'Hubo un error al guardar el dispositivo. Por favor, verifica los datos.',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#d33'
                        });
                    }
                })
                .catch(error => {
                    Swal.close();
                    console.error('üí• Error en la solicitud:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Conexi√≥n',
                        text: 'No se pudo registrar el dispositivo. Intenta nuevamente.',
                        confirmButtonText: 'Reintentar',
                        confirmButtonColor: '#d33'
                    });
                });
            });
        }
    });

    console.log('‚úÖ Script completamente configurado');
}
</script>

<!-- Script para contador de caracteres en observaciones -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textareaObservaciones = document.querySelector('textarea[name="observaciones"]');
    const contadorObservaciones = document.getElementById('contador-observaciones');

    const LIMITE_OBSERVACIONES = 400;

    function actualizarContadorObservaciones() {
        if (!textareaObservaciones || !contadorObservaciones) return;

        const caracteresActuales = textareaObservaciones.value.length;
        const caracteresRestantes = LIMITE_OBSERVACIONES - caracteresActuales;

        contadorObservaciones.textContent = `${caracteresRestantes} caracteres restantes`;

        // Cambiar color seg√∫n los caracteres restantes
        if (caracteresRestantes <= 0) {
            contadorObservaciones.className = 'text-danger small fw-bold';
            textareaObservaciones.classList.add('is-invalid');
        } else if (caracteresRestantes <= 50) {
            contadorObservaciones.className = 'text-warning small';
            textareaObservaciones.classList.remove('is-invalid');
        } else {
            contadorObservaciones.className = 'text-muted small';
            textareaObservaciones.classList.remove('is-invalid');
        }
    }

    if (textareaObservaciones && contadorObservaciones) {
        textareaObservaciones.addEventListener('input', function() {
            // Limitar caracteres en tiempo real
            if (this.value.length > LIMITE_OBSERVACIONES) {
                this.value = this.value.substring(0, LIMITE_OBSERVACIONES);
            }
            actualizarContadorObservaciones();
        });

        // Inicializar con el valor actual
        actualizarContadorObservaciones();
    }
});
</script>

<!-- Scripts existentes mejorados (manteniendo la funcionalidad) -->
<script>
function configurarFormularioCita() {
    const formCita = document.getElementById('form-cita');

    if (formCita) {
        formCita.addEventListener('submit', function(e) {
            e.preventDefault();

            // Validar campos requeridos
            const asesor = document.querySelector('select[name="asesor"]').value;
            const dispositivo = document.getElementById('id_dispositivo').value;
            const fecha = document.querySelector('input[name="fecha_cita"]').value;
            const hora = document.querySelector('input[name="hora_cita"]').value;
            const tipoServicio = document.querySelector('select[name="tipo_servicio"]').value;

            let errores = [];

            if (!asesor) errores.push('Debes seleccionar un asesor.');
            if (!dispositivo) errores.push('Debes seleccionar un dispositivo.');
            if (!fecha) errores.push('Debes seleccionar una fecha.');
            if (!hora) errores.push('Debes seleccionar una hora.');
            if (!tipoServicio) errores.push('Debes seleccionar un tipo de servicio.');

            if (errores.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Campos Requeridos',
                    html: `
                        <div class="text-start">
                            <p>Por favor completa los siguientes campos:</p>
                            <ul class="small">
                                ${errores.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    `,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }

            // Obtener datos para el resumen
            const asesorSelect = document.querySelector('select[name="asesor"]');
            const asesorText = asesorSelect.options[asesorSelect.selectedIndex].text;
            const dispositivoSelect = document.getElementById('id_dispositivo');
            const dispositivoText = dispositivoSelect.options[dispositivoSelect.selectedIndex].text;

            // Mostrar confirmaci√≥n con resumen
            Swal.fire({
                title: '¬øConfirmar Cita?',
                html: `
                    <div class="text-start">
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Asesor:</strong></p>
                                <p><strong>Dispositivo:</strong></p>
                                <p><strong>Fecha:</strong></p>
                                <p><strong>Hora:</strong></p>
                                <p><strong>Servicio:</strong></p>
                            </div>
                            <div class="col-6">
                                <p>${asesorText}</p>
                                <p>${dispositivoText}</p>
                                <p>${fecha}</p>
                                <p>${hora}</p>
                                <p>${tipoServicio}</p>
                            </div>
                        </div>
                        <p class="mt-3 text-muted border-top pt-2">¬øEst√°s seguro de que quieres agendar esta cita?</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, Agendar Cita',
                cancelButtonText: 'Revisar Datos',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                backdrop: true,
                width: '600px'
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarFormularioCita(this);
                }
            });
        });
    }
}

function enviarFormularioCita(form) {
    // Mostrar loading
    Swal.fire({
        title: 'Agendando cita...',
        text: 'Por favor espera un momento',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    const formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => {
        if (response.redirected) {
            // √âxito - redirecci√≥n
            Swal.fire({
                icon: 'success',
                title: '¬°Cita Agendada!',
                html: `
                    <div class="text-center">
                        <i class="fas fa-calendar-check text-success mb-3" style="font-size: 3rem;"></i>
                        <p class="mb-2">Tu cita se ha agendado correctamente.</p>
                        <p class="text-muted small">Ser√°s redirigido al inicio...</p>
                    </div>
                `,
                showConfirmButton: false,
                timer: 2500,
                timerProgressBar: true,
                didClose: () => {
                    window.location.href = response.url;
                }
            });
        } else {
            return response.text().then(text => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Validaci√≥n',
                    text: 'Por favor verifica los datos del formulario',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545'
                });
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error de Conexi√≥n',
            text: 'No se pudo agendar la cita. Intenta nuevamente.',
            confirmButtonText: 'Reintentar',
            confirmButtonColor: '#dc3545'
        });
    });
}

// Configurar validaciones de fecha y hora
function configurarValidacionesCita() {
    const fechaInput = document.querySelector('input[name="fecha_cita"]');
    const horaInput = document.querySelector('input[name="hora_cita"]');

    if (fechaInput) {
        // Establecer fecha m√≠nima (ma√±ana)
        const hoy = new Date();
        const manana = new Date(hoy);
        manana.setDate(hoy.getDate() + 1);
        const fechaMinima = manana.toISOString().split('T')[0];
        fechaInput.min = fechaMinima;

        // Agregar validaci√≥n en tiempo real
        fechaInput.addEventListener('change', validarFecha);
    }

    if (horaInput) {
        // Configurar horario restringido
        horaInput.min = '08:00';
        horaInput.max = '14:00';
        horaInput.step = '1800';

        // Agregar validaci√≥n en tiempo real
        horaInput.addEventListener('change', validarHora);

        // Forzar horario dentro del rango
        horaInput.addEventListener('input', function() {
            if (this.value) {
                const [horas, minutos] = this.value.split(':').map(Number);
                const horaDecimal = horas + minutos / 60;

                if (horaDecimal < 8) {
                    this.value = '08:00';
                } else if (horaDecimal > 14) {
                    this.value = '14:00';
                }
            }
        });
    }
}

// Funciones de validaci√≥n (mantener las existentes)
function validarFecha() {
    const fechaInput = document.querySelector('input[name="fecha_cita"]');
    const fechaSeleccionada = new Date(fechaInput.value);
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    if (fechaInput.value) {
        if (fechaSeleccionada < hoy) {
            mostrarError('No se pueden agendar citas en fechas pasadas.');
            return false;
        } else if (fechaSeleccionada.getTime() === hoy.getTime()) {
            mostrarError('Las citas deben agendarse con al menos un d√≠a de anticipaci√≥n.');
            return false;
        } else {
            verificarDisponibilidadFecha(fechaInput.value);
            return true;
        }
    }
    return false;
}

function validarHora() {
    const horaInput = document.querySelector('input[name="hora_cita"]');
    if (horaInput.value) {
        const [horas, minutos] = horaInput.value.split(':').map(Number);
        const horaSeleccionada = horas + minutos / 60;
        if (horaSeleccionada < 8 || horaSeleccionada > 14) {
            mostrarError('El horario debe estar entre 8:00 AM y 2:00 PM.');
            return false;
        }
        return true;
    }
    return false;
}

function verificarDisponibilidadFecha(fecha) {
    fetch(`/citas/verificar-fecha/?fecha=${fecha}`)
        .then(response => response.json())
        .then(data => {
            if (!data.disponible) {
                mostrarError('Ya existe una cita agendada para esta fecha. Por favor selecciona otra fecha.');
            }
        })
        .catch(error => console.error('Error verificando fecha:', error));
}

function mostrarError(mensaje) {
    Swal.fire({
        icon: 'warning',
        title: 'Validaci√≥n',
        text: mensaje,
        confirmButtonText: 'Entendido',
        confirmButtonColor: '#ffc107'
    });
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    configurarValidacionesCita();
    configurarFormularioCita();
});

// Mostrar mensajes de Django
function mostrarMensajes() {
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' %}
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Permisos',
                    html: `{{ message|safe }}`,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545',
                    backdrop: true,
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            {% elif message.tags == 'success' %}
                Swal.fire({
                    icon: 'success',
                    title: '¬°√âxito!',
                    text: '{{ message }}',
                    confirmButtonText: 'Aceptar',
                    confirmButtonColor: '#28a745',
                    timer: 3000,
                    timerProgressBar: true
                });
            {% endif %}
        {% endfor %}
    {% endif %}
}

document.addEventListener('DOMContentLoaded', mostrarMensajes);
</script>

{% else %}
<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="fas fa-ban text-danger mb-3" style="font-size: 4rem;"></i>
        <h3 class="text-danger">Acceso Denegado</h3>
        <p class="text-muted">No tienes permisos para acceder a esta p√°gina. Solo usuarios con rol de Admin o Cliente pueden agendar citas.</p>
        <a href="{% url 'inicio:home' %}" class="btn btn-primary mt-3">
          <i class="fas fa-home me-2"></i>Volver al Inicio
        </a>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}