{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Producto{% endblock %}

{% block content %}
<style>
    .form-container {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 40px;
        margin: 20px 0;
        border: 1px solid var(--border-color);
        box-shadow: 0 20px 40px var(--shadow-color);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .form-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent-purple) 0%, var(--accent-green) 50%, var(--accent-yellow) 100%);
    }

    .form-header {
        text-align: center;
        margin-bottom: 40px;
        position: relative;
    }

    .form-title {
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        font-size: 2.5rem;
        background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-green) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .form-subtitle {
        color: var(--text-secondary);
        font-family: 'Poppins', sans-serif;
        font-weight: 300;
        font-size: 1.1rem;
    }

    .form-card {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 30px;
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }

    .form-card:hover {
        background: var(--bg-secondary);
        border-color: var(--accent-purple);
        transform: translateY(-2px);
    }

    .form-label {
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
    }

    .form-label i {
        margin-right: 10px;
        font-size: 1.2rem;
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* ESTILOS UNIFICADOS PARA TODOS LOS SELECTS */
    .form-select {
        background: var(--search-bg) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 12px !important;
        color: var(--text-primary) !important;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        padding: 15px 20px !important;
        transition: all 0.3s ease;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        cursor: pointer;
        width: 100%;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23E040FB' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: calc(100% - 20px) center !important;
        background-size: 16px 16px !important;
    }

    .form-select:focus {
        background: var(--bg-card) !important;
        border-color: var(--accent-purple) !important;
        box-shadow: 0 0 0 3px rgba(224, 64, 251, 0.1) !important;
        color: var(--text-primary) !important;
        outline: none;
    }

    .form-select:hover {
        border-color: var(--accent-purple) !important;
        background: var(--bg-secondary) !important;
    }

    .form-select option {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
        padding: 12px 15px !important;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95rem;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .form-select option:hover {
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
        color: #000000 !important;
        font-weight: 600;
    }

    .form-select option:checked {
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)) !important;
        color: #000000 !important;
        font-weight: 600;
    }

    .form-input, .form-textarea {
        background: var(--search-bg) !important;
        border: 2px solid var(--border-color) !important;
        border-radius: 12px !important;
        color: var(--text-primary) !important;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        padding: 15px 20px !important;
        transition: all 0.3s ease;
    }

    .form-input:focus, .form-textarea:focus {
        background: var(--bg-card) !important;
        border-color: var(--accent-purple) !important;
        box-shadow: 0 0 0 3px rgba(224, 64, 251, 0.1) !important;
        color: var(--text-primary) !important;
        outline: none;
    }

    .form-input::placeholder, .form-textarea::placeholder {
        color: var(--text-muted) !important;
    }

    .form-text {
        color: var(--text-muted) !important;
        font-family: 'Poppins', sans-serif;
        font-size: 0.9rem;
        margin-top: 8px;
        display: flex;
        align-items: center;
    }

    .form-text i {
        margin-right: 6px;
        color: var(--accent-green);
    }

    .char-counter {
        font-family: 'Poppins', sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-green) 100%);
        border: none;
        border-radius: 12px;
        padding: 15px 30px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1.1rem;
        color: #000000;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(224, 64, 251, 0.3);
    }

    .btn-primary-custom:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(224, 64, 251, 0.4);
        color: #000000;
    }

    .btn-secondary-custom {
        background: var(--search-bg);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 15px 30px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    .btn-secondary-custom:hover {
        background: var(--bg-card);
        border-color: var(--accent-purple);
        color: var(--text-primary);
        transform: translateY(-2px);
    }

    .grid-2-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    .form-check-input {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        background: var(--search-bg);
        border: 2px solid var(--border-color);
    }

    .form-check-input:checked {
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
        border-color: var(--accent-purple);
    }

    .form-check-label {
        font-family: 'Poppins', sans-serif;
        color: var(--text-primary);
        display: flex;
        align-items: center;
    }

    /* Estilos para la imagen actual */
    .current-image-container {
        background: var(--search-bg);
        border-radius: 12px;
        padding: 20px;
        border: 2px dashed var(--border-color);
        text-align: center;
        margin-bottom: 20px;
    }

    .current-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 4px 15px var(--shadow-color);
        border: 2px solid var(--border-color);
    }

    .image-info {
        margin-top: 10px;
        color: var(--accent-green);
        font-family: 'Poppins', sans-serif;
        font-size: 0.9rem;
    }

    .no-image-alert {
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.3);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
    }

    .no-image-alert i {
        color: #FFC107;
        font-size: 2rem;
        margin-bottom: 10px;
    }

    /* Estados de validaci칩n */
    .is-invalid {
        border-color: #FF7F7F !important;
        box-shadow: 0 0 0 3px rgba(255, 127, 127, 0.1) !important;
    }

    .is-valid {
        border-color: var(--accent-green) !important;
        box-shadow: 0 0 0 3px rgba(145, 255, 182, 0.1) !important;
    }

    .error-message {
        color: #FF7F7F;
        font-family: 'Poppins', sans-serif;
        font-size: 0.85rem;
        margin-top: 5px;
        display: flex;
        align-items: center;
    }

    .error-message i {
        margin-right: 5px;
    }

    /* Estilos espec칤ficos para modo claro */
    [data-theme="light"] .form-container {
        box-shadow: 0 10px 30px var(--shadow-color);
    }

    [data-theme="light"] .form-card:hover {
        box-shadow: 0 8px 25px var(--shadow-color);
    }

    [data-theme="light"] .btn-primary-custom {
        color: #000000;
    }

    [data-theme="light"] .btn-primary-custom:hover {
        color: #000000;
    }

    [data-theme="light"] .current-image-container {
        background: var(--bg-secondary);
    }

    @media (max-width: 768px) {
        .form-container {
            padding: 25px;
            margin: 10px;
        }

        .form-title {
            font-size: 2rem;
        }

        .grid-2-col {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .btn-primary-custom,
        .btn-secondary-custom {
            width: 100%;
            margin-bottom: 10px;
        }
    }
</style>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <div class="form-container">
                <div class="form-header">
                    <h1 class="form-title">
                        <i class="fas fa-edit me-3"></i>
                        Editar Producto: {{ producto.nombre }}
                    </h1>
                    <p class="form-subtitle">Actualiza la informaci칩n del producto en el cat치logo</p>
                </div>

                <form method="post" enctype="multipart/form-data" id="form-editar-producto">
                    {% csrf_token %}

                    <!-- Informaci칩n B치sica -->
                    <div class="form-card">
                        <h3 class="mb-4" style="font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-info-circle me-2" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                            Informaci칩n B치sica
                        </h3>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-tag"></i>
                                Nombre del Producto
                            </label>
                            {{ form.nombre }}
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Nombre descriptivo del producto
                                </div>
                                <span id="contador-nombre" class="char-counter" style="color: var(--text-muted);">100 caracteres restantes</span>
                            </div>
                            {% if form.nombre.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    {{ form.nombre.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-align-left"></i>
                                Descripci칩n
                            </label>
                            {{ form.descripcion }}
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Describe las caracter칤sticas principales del producto
                                </div>
                                <span id="contador-descripcion" class="char-counter" style="color: var(--text-muted);">300 caracteres restantes</span>
                            </div>
                            {% if form.descripcion.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    {{ form.descripcion.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Precio y Stock -->
                    <div class="form-card">
                        <h3 class="mb-4" style="font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-chart-bar me-2" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                            Precio y Inventario
                        </h3>

                        <div class="grid-2-col">
                            <div>
                                <label class="form-label">
                                    <i class="fas fa-dollar-sign"></i>
                                    Precio (COP)
                                </label>
                                {{ form.precio }}
                                {% if form.precio.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.precio.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div>
                                <label class="form-label">
                                    <i class="fas fa-boxes"></i>
                                    Stock Disponible
                                </label>
                                {{ form.stock }}
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    M치ximo 999 unidades
                                </div>
                                {% if form.stock.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.stock.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Imagen y Categor칤a -->
                    <div class="form-card">
                        <h3 class="mb-4" style="font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--text-primary);">
                            <i class="fas fa-images me-2" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                            Multimedia y Categorizaci칩n
                        </h3>

                        <!-- Imagen Actual -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-image"></i>
                                Imagen Actual del Producto
                            </label>

                            {% if producto.imagen %}
                                <div class="current-image-container">
                                    <img src="{{ producto.imagen }}" alt="{{ producto.nombre }}" class="current-image">
                                    <div class="image-info">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Imagen actual del producto
                                    </div>
                                </div>
                            {% else %}
                                <div class="no-image-alert">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p class="mb-0 mt-2" style="color: var(--text-primary);">Este producto no tiene imagen asignada.</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Nueva Imagen -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-sync-alt"></i>
                                Cambiar Imagen (Opcional)
                            </label>
                            {{ form.imagen_archivo }}
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i>
                                Selecciona una nueva imagen para reemplazar la existente. Formatos: JPG, PNG, GIF. Tama침o m치ximo: 5MB.
                            </div>
                            {% if form.imagen_archivo.errors %}
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    {{ form.imagen_archivo.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="grid-2-col">
                            <div>
                                <label class="form-label">
                                    <i class="fas fa-folder"></i>
                                    Categor칤a
                                </label>
                                {{ form.categoria }}
                                {% if form.categoria.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.categoria.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div>
                                <label class="form-label">
                                    <i class="fas fa-toggle-on"></i>
                                    Estado
                                </label>
                                <div class="form-check form-switch mt-2">
                                    {{ form.activo }}
                                    <label class="form-check-label" for="{{ form.activo.id_for_label }}">
                                        Producto activo
                                    </label>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Los productos inactivos no se mostrar치n en la tienda
                                </div>
                                {% if form.activo.errors %}
                                    <div class="error-message">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ form.activo.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acci칩n -->
                    <div class="d-flex gap-3 pt-4 border-top" style="border-color: var(--border-color) !important; justify-content: center; flex-wrap;">
                        <button type="submit" class="btn btn-primary-custom" id="btn-guardar">
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                        <a href="{% url 'tienda:lista_productos' %}" class="btn btn-secondary-custom">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Script para aplicar estilos autom치ticamente -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar estilos a todos los elementos del formulario
    function aplicarEstilosFormulario() {
        // Aplicar a selects
        const allSelects = document.querySelectorAll('select');
        allSelects.forEach(select => {
            select.classList.add('form-select');

            // Agregar opci칩n por defecto si no existe
            if (!select.querySelector('option[value=""]') && select.required) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Selecciona una opci칩n';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.insertBefore(defaultOption, select.firstChild);
            }
        });

        // Aplicar a inputs de texto
        const textInputs = document.querySelectorAll('input[type="text"], input[type="number"]');
        textInputs.forEach(input => {
            input.classList.add('form-input');
        });

        // Aplicar a textareas
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.classList.add('form-textarea');
        });

        // Aplicar a inputs de archivo
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.classList.add('form-input');
        });

        // Aplicar estilos al checkbox
        const checkbox = document.querySelector('input[type="checkbox"]');
        if (checkbox) {
            checkbox.classList.add('form-check-input');
        }
    }

    aplicarEstilosFormulario();
});
</script>

<!-- Script para formato de precio COP -->
<script>
  (function(){
    function formatCOP(val){
      if(!val) return '';
      const digits = val.replace(/\D+/g,'');
      if(!digits) return '';
      return digits.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function attach(el){
      if(!el) return;
      el.value = formatCOP(el.value);
      el.addEventListener('input', function(e){
        const before = el.value;
        const formatted = formatCOP(before);
        el.value = formatted;
        try { el.setSelectionRange(el.value.length, el.value.length); } catch(_){ }
      });
      el.addEventListener('blur', function(){ el.value = formatCOP(el.value); });
      el.setAttribute('placeholder', '0');
    }

    document.addEventListener('DOMContentLoaded', function(){
      var inputs = document.querySelectorAll('input.precio-cop');
      if(inputs && inputs.length){ inputs.forEach(attach); }
    });
  })();
</script>

<!-- Script para contadores de caracteres y validaci칩n de stock -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Funci칩n para obtener estilos del tema actual
function getThemeStyles() {
    const styles = getComputedStyle(document.documentElement);
    return {
        background: styles.getPropertyValue('--bg-primary').trim(),
        color: styles.getPropertyValue('--text-primary').trim(),
        borderColor: styles.getPropertyValue('--border-color').trim()
    };
}

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('form-editar-producto');
  const inputNombre = document.querySelector('input[name="nombre"]');
  const textareaDescripcion = document.querySelector('textarea[name="descripcion"]');
  const inputStock = document.querySelector('input[name="stock"]');
  const contadorNombre = document.getElementById('contador-nombre');
  const contadorDescripcion = document.getElementById('contador-descripcion');

  // L칤mites de caracteres
  const LIMITE_NOMBRE = 100;
  const LIMITE_DESCRIPCION = 300;
  const MAX_STOCK = 999;

  // 游댳 INICIALIZAR CONTADORES
  function inicializarContadores() {
    actualizarContador(inputNombre, contadorNombre, LIMITE_NOMBRE);
    actualizarContador(textareaDescripcion, contadorDescripcion, LIMITE_DESCRIPCION);
  }

  // 游댳 FUNCI칍N: Actualizar contador de caracteres
  function actualizarContador(elemento, contador, limite) {
    if (!elemento || !contador) return;

    const caracteresActuales = elemento.value.length;
    const caracteresRestantes = limite - caracteresActuales;

    contador.textContent = `${caracteresRestantes} caracteres restantes`;

    // Cambiar color seg칰n los caracteres restantes
    if (caracteresRestantes <= 0) {
      contador.style.color = '#FF7F7F';
      contador.style.fontWeight = 'bold';
      elemento.classList.add('is-invalid');
    } else if (caracteresRestantes <= 20) {
      contador.style.color = '#FFA500';
      elemento.classList.remove('is-invalid');
    } else {
      contador.style.color = 'var(--text-muted)';
      elemento.classList.remove('is-invalid');
    }
  }

  // 游댳 FUNCI칍N: Validar y limitar stock
  function validarStock(input) {
    if (!input) return;

    let valor = input.value.replace(/\D/g, ''); // Solo n칰meros
    valor = valor.slice(0, 3); // M치ximo 3 d칤gitos

    if (valor > MAX_STOCK) {
      valor = MAX_STOCK;
    }

    input.value = valor;

    // Actualizar clase visual
    if (valor > 0) {
      input.classList.remove('is-invalid');
      input.classList.add('is-valid');
    } else {
      input.classList.remove('is-valid');
    }
  }

  // 游댳 EVENT LISTENERS para contadores
  if (inputNombre && contadorNombre) {
    inputNombre.addEventListener('input', function() {
      // Limitar caracteres en tiempo real
      if (this.value.length > LIMITE_NOMBRE) {
        this.value = this.value.substring(0, LIMITE_NOMBRE);
      }
      actualizarContador(this, contadorNombre, LIMITE_NOMBRE);
    });

    // Inicializar con el valor actual
    actualizarContador(inputNombre, contadorNombre, LIMITE_NOMBRE);
  }

  if (textareaDescripcion && contadorDescripcion) {
    textareaDescripcion.addEventListener('input', function() {
      // Limitar caracteres en tiempo real
      if (this.value.length > LIMITE_DESCRIPCION) {
        this.value = this.value.substring(0, LIMITE_DESCRIPCION);
      }
      actualizarContador(this, contadorDescripcion, LIMITE_DESCRIPCION);
    });

    // Inicializar con el valor actual
    actualizarContador(textareaDescripcion, contadorDescripcion, LIMITE_DESCRIPCION);
  }

  // 游댳 EVENT LISTENER para stock
  if (inputStock) {
    inputStock.addEventListener('input', function() {
      validarStock(this);
    });

    inputStock.addEventListener('blur', function() {
      validarStock(this);
    });

    // Inicializar validaci칩n
    validarStock(inputStock);

    // Prevenir entrada de caracteres no num칠ricos
    inputStock.addEventListener('keypress', function(e) {
      const charCode = e.which ? e.which : e.keyCode;
      if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        e.preventDefault();
        return false;
      }
      return true;
    });
  }

  // 游댳 VALIDACI칍N DEL FORMULARIO antes de enviar
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      // Validar campos requeridos
      const nombre = inputNombre.value.trim();
      const descripcion = textareaDescripcion.value.trim();
      const precio = document.querySelector('input[name="precio"]').value.trim();
      const stock = inputStock.value.trim();

      let errores = [];

      // Validar nombre
      if (!nombre) {
        errores.push('El nombre del producto es obligatorio.');
      } else if (nombre.length > LIMITE_NOMBRE) {
        errores.push(`El nombre no puede exceder ${LIMITE_NOMBRE} caracteres.`);
      }

      // Validar descripci칩n
      if (descripcion.length > LIMITE_DESCRIPCION) {
        errores.push(`La descripci칩n no puede exceder ${LIMITE_DESCRIPCION} caracteres.`);
      }

      // Validar precio
      if (!precio || parseInt(precio.replace(/\D/g, '')) <= 0) {
        errores.push('El precio debe ser mayor a cero.');
      }

      // Validar stock
      if (stock && (parseInt(stock) < 0 || parseInt(stock) > MAX_STOCK)) {
        errores.push(`El stock debe estar entre 0 y ${MAX_STOCK}.`);
      }

      // Mostrar errores si los hay
      if (errores.length > 0) {
        const theme = getThemeStyles();
        Swal.fire({
          icon: 'error',
          title: 'Errores en el Formulario',
          html: `
            <div class="text-start">
              <p>Por favor corrige los siguientes errores:</p>
              <ul class="small">
                ${errores.map(error => `<li>${error}</li>`).join('')}
              </ul>
            </div>
          `,
          confirmButtonText: 'Entendido',
          confirmButtonColor: '#dc3545',
          background: theme.background,
          color: theme.color
        });
        return;
      }

      const theme = getThemeStyles();

      // Mostrar confirmaci칩n
      Swal.fire({
        title: '쮾uardar Cambios?',
        html: `
          <div class="text-start">
            <p><strong>Producto:</strong> ${nombre}</p>
            <p><strong>Precio:</strong> $${formatNumber(precio)} COP</p>
            <p><strong>Stock:</strong> ${stock || '0'} unidades</p>
            <p><strong>Caracteres usados:</strong> ${nombre.length}/${LIMITE_NOMBRE} (nombre), ${descripcion.length}/${LIMITE_DESCRIPCION} (descripci칩n)</p>
            <p class="text-muted small mt-2">쮺onfirmas que quieres guardar los cambios en este producto?</p>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S칤, Guardar Cambios',
        cancelButtonText: 'Seguir Editando',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        backdrop: true,
        width: '500px',
        background: theme.background,
        color: theme.color
      }).then((result) => {
        if (result.isConfirmed) {
          const theme = getThemeStyles();

          // Mostrar loading
          Swal.fire({
            title: 'Actualizando Producto...',
            text: 'Por favor espera un momento',
            allowOutsideClick: false,
            background: theme.background,
            color: theme.color,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          // Enviar formulario
          form.submit();
        }
      });
    });
  }

  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
});

// Mostrar mensajes de Django
function mostrarMensajes() {
  {% if messages %}
    {% for message in messages %}
      const theme = getThemeStyles();
      {% if message.tags == 'success' %}
        Swal.fire({
          icon: 'success',
          title: '춰칄xito!',
          text: '{{ message }}',
          confirmButtonText: 'Aceptar',
          confirmButtonColor: '#28a745',
          timer: 3000,
          timerProgressBar: true,
          background: theme.background,
          color: theme.color
        });
      {% elif message.tags == 'error' %}
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: '{{ message }}',
          confirmButtonText: 'Entendido',
          confirmButtonColor: '#dc3545',
          background: theme.background,
          color: theme.color
        });
      {% endif %}
    {% endfor %}
  {% endif %}
}

document.addEventListener('DOMContentLoaded', mostrarMensajes);
</script>
{% endblock %}