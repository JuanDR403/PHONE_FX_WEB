{% extends 'base.html' %}
{% load static %}

{% block title %}Tienda - Productos{% endblock %}

{% block content %}
<style>
  /* Posicionar flechas por fuera del carrusel, a izquierda/derecha */
  .carousel-outer-controls { position: relative; }
  .carousel-outer-controls .carousel-control-prev,
  .carousel-outer-controls .carousel-control-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 2.75rem; /* botón un poco más pequeño */
    height: 2.75rem;
    opacity: 0.9;
  }
  .carousel-outer-controls .carousel-control-prev { left: -2.5rem; }
  .carousel-outer-controls .carousel-control-next { right: -2.5rem; }
  /* Asegurar que no cubran las tarjetas */
  .carousel-outer-controls .carousel-control-prev,
  .carousel-outer-controls .carousel-control-next { pointer-events: auto; z-index: 3; }
  /* En pantallas pequeñas, traer las flechas un poco hacia adentro para que no se corten */
  @media (max-width: 576px) {
    .carousel-outer-controls .carousel-control-prev { left: -1rem; }
    .carousel-outer-controls .carousel-control-next { right: -1rem; }
  }
</style>
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
      <div class="d-flex align-items-center gap-2">
        <h2 class="h4 mb-0">Productos</h2>
        {% if categoria_seleccionada %}
          {% for c in categorias %}
            {% if c.idcategoria == categoria_seleccionada %}
              <span class="badge text-bg-primary ms-2">Categoría: {{ c.nombre }}</span>
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>
      <div class="d-flex align-items-center gap-2">
        <form method="get" class="d-flex align-items-center gap-2">
          <label for="categoria" class="form-label mb-0">Categoría:</label>
          <select id="categoria" name="categoria" class="form-select" onchange="this.form.submit()">
            <option value="" {% if not categoria_seleccionada %}selected{% endif %}>Todas</option>
            {% for cat in categorias %}
              <option value="{{ cat.idcategoria }}" {% if categoria_seleccionada == cat.idcategoria %}selected{% endif %}>{{ cat.nombre }}</option>
            {% empty %}
              <option disabled>No hay categorías</option>
            {% endfor %}
          </select>
        </form>
        <a href="{% url 'tienda:crear_producto' %}" class="btn btn-success">Agregar producto</a>
      </div>
    </div>
  </div>
</div>

{% if not categoria_seleccionada %}
  {# Vista por categorías en carruseles cuando el filtro está en "Todas" #}
  {% for c in categorias %}
    {% with prods=c.productos.all %}
      {% if prods %}
      <div class="mb-5 position-relative carousel-outer-controls">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="h5 mb-0">{{ c.nombre }}</h3>
          <a class="btn btn-outline-primary btn-sm" href="?categoria={{ c.idcategoria }}">Ver Mas...</a>
        </div>

        <div id="carousel-{{ c.idcategoria }}" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for p in prods %}
              {% if forloop.first or forloop.counter0|divisibleby:3 %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <div class="row g-3">
              {% endif %}

              <div class="col-12 col-sm-6 col-lg-4">
                <div class="card h-100">
                  {% if p.imagen %}
                    <img src="{{ p.imagen }}" class="card-img-top" alt="{{ p.nombre }}" style="width: 250px; height: 250px; object-fit: cover; display: block; margin-left: auto; margin-right: auto;">
                  {% else %}
                    <svg class="bd-placeholder-img card-img-top" width="250" height="250" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Sin imagen</title><rect width="100%" height="100%" fill="#868e96"></rect><text x="50%" y="50%" fill="#dee2e6" dy=".3em" text-anchor="middle">Sin imagen</text></svg>
                  {% endif %}
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ p.nombre }}</h5>
                    <p class="card-text small text-muted mb-1">{% if p.categoria and p.categoria.nombre %}{{ p.categoria.nombre }}{% else %}Sin categoría{% endif %}</p>
                    <p class="card-text fw-bold">{{ p.precio }}</p>
                    {% if p.descripcion %}
                    <div id="desc-{{ p.idproducto }}" class="card-text" style="overflow: hidden; max-height: 4.5em;">{{ p.descripcion }}</div>
                    {% if p.descripcion|length > 140 %}
                    <button type="button" class="btn btn-link p-0 mt-1" onclick="(function(btn){var el=document.getElementById('desc-{{ p.idproducto }}');if(el.style.maxHeight && el.style.maxHeight!=='none'){el.style.maxHeight='none';btn.textContent='Ver menos';}else{el.style.maxHeight='4.5em';btn.textContent='Ver más';}})(this)">Ver más</button>
                    {% endif %}
                    {% endif %}
                    <div class="mt-auto">
                      {% if p.stock %}
                        <span class="badge text-bg-success">En stock: {{ p.stock }}</span>
                      {% else %}
                        <span class="badge text-bg-secondary">Sin stock</span>
                      {% endif %}
                      <div class="d-flex gap-2 mt-3">
                        <a href="{% url 'tienda:editar_producto' p.idproducto %}" class="btn btn-sm btn-outline-primary">Editar</a>
                        <form method="post" action="{% url 'tienda:eliminar_producto' p.idproducto %}" onsubmit="return confirm('¿Seguro que deseas eliminar este producto?');">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {% if forloop.counter|divisibleby:'3' or forloop.last %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>

        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ c.idcategoria }}" data-bs-slide="prev" aria-label="Anterior">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#89259C" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
          </svg>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ c.idcategoria }}" data-bs-slide="next" aria-label="Siguiente">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#89259C" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
          </svg>
        </button>
      </div>
      {% endif %}
    {% endwith %}
  {% endfor %}
{% else %}
  <div class="row g-3">
    {% for p in productos %}
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card h-100">
        {% if p.imagen %}
          <img src="{{ p.imagen }}" class="card-img-top" alt="{{ p.nombre }}" style="width: 250px; height: 250px; object-fit: cover; display: block; margin-left: auto; margin-right: auto;">
        {% else %}
          <svg class="bd-placeholder-img card-img-top" width="250" height="250" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Sin imagen</title><rect width="100%" height="100%" fill="#868e96"></rect><text x="50%" y="50%" fill="#dee2e6" dy=".3em" text-anchor="middle">Sin imagen</text></svg>
        {% endif %}
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ p.nombre }}</h5>
          <p class="card-text small text-muted mb-1">{% if p.categoria and p.categoria.nombre %}{{ p.categoria.nombre }}{% else %}Sin categoría{% endif %}</p>
          <p class="card-text fw-bold">{{ p.precio }}</p>
          {% if p.descripcion %}
          <div id="desc-{{ p.idproducto }}" class="card-text" style="overflow: hidden; max-height: 4.5em;">{{ p.descripcion }}</div>
          {% if p.descripcion|length > 140 %}
          <button type="button" class="btn btn-link p-0 mt-1" onclick="(function(btn){var el=document.getElementById('desc-{{ p.idproducto }}');if(el.style.maxHeight && el.style.maxHeight!=='none'){el.style.maxHeight='none';btn.textContent='Ver menos';}else{el.style.maxHeight='4.5em';btn.textContent='Ver más';}})(this)">Ver más</button>
          {% endif %}
          {% endif %}
          <div class="mt-auto">
            {% if p.stock %}
              <span class="badge text-bg-success">En stock: {{ p.stock }}</span>
            {% else %}
              <span class="badge text-bg-secondary">Sin stock</span>
            {% endif %}
            <div class="d-flex gap-2 mt-3">
              <a href="{% url 'tienda:editar_producto' p.idproducto %}" class="btn btn-sm btn-outline-primary">Editar</a>
              <form method="post" action="{% url 'tienda:eliminar_producto' p.idproducto %}" onsubmit="return confirm('¿Seguro que deseas eliminar este producto?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="alert alert-info">No se encontraron productos para esta categoría.</div>
    </div>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}
